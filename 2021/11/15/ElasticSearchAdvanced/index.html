

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/mario.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="ElasticSearch基本使用">
  <meta name="author" content="tho">
  <meta name="keywords" content="">
  <meta name="description" content="ElasticSearch基本使用">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="http://example.com/2021/11/15/ElasticSearchAdvanced/index.html">
<meta property="og:site_name" content="Tho668&#39;s Blogs">
<meta property="og:description" content="ElasticSearch基本使用">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-15T07:35:56.000Z">
<meta property="article:modified_time" content="2022-03-04T14:06:02.067Z">
<meta property="article:author" content="tho">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary_large_image">
  
  <title>ElasticSearch - Tho668&#39;s Blogs</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tho668</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/galaxy.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="ElasticSearch">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-15 15:35" pubdate>
        November 15, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      52k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      164 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ElasticSearch</h1>
            
            <div class="markdown-body">
              <p>ElasticSearch基本使用</p>
<span id="more"></span>





<p>设置本机为固定ip</p>
<ul>
<li>ipv4协议 属性</li>
</ul>
<p>mysql远程连接配置</p>
<h1 id="一、ElasticSearch基础"><a href="#一、ElasticSearch基础" class="headerlink" title="一、ElasticSearch基础"></a>一、ElasticSearch基础</h1><h2 id="1-1、ES介绍"><a href="#1-1、ES介绍" class="headerlink" title="1.1、ES介绍"></a>1.1、ES介绍</h2><p>1、ES核心术语</p>
<ul>
<li>索引 index           表</li>
<li>类型 type             表逻辑类型 (es 7.x版本已删去)</li>
<li>文档 document    行</li>
<li>字段 fields            列</li>
</ul>
<p>2、ES核心概念</p>
<ul>
<li>映射 mapping      表结构定义</li>
<li>近实时 NRT          Near real time </li>
<li>节点 node            每一个服务器</li>
<li>shard replica        数据分片 备份</li>
</ul>
<p>3、ES集群架构原理</p>
<pre><code>&gt;将数据进行分片,并行计算
&gt;
&gt;shard(主分片)      replica(备份分片)
</code></pre>
<h2 id="1-2、倒排索引"><a href="#1-2、倒排索引" class="headerlink" title="1.2、倒排索引"></a>1.2、倒排索引</h2><blockquote>
<p>ElasticSearch 倒排索引</p>
<p>倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和包含该属性值的各个记录地址。由于不是根据记录来确定属性，而是根据属性来确定记录的位置，所以称之为倒排索引。</p>
</blockquote>
<h2 id="1-3、ES环境搭建"><a href="#1-3、ES环境搭建" class="headerlink" title="1.3、ES环境搭建"></a>1.3、ES环境搭建</h2><p>1.解压es压缩包 到 <code>/usr/local/elasticsearch</code> 下</p>
<p><code>tar -zxvf /root/workspace/software/elasticsearch-7.15.2-linux-x86_64.tar.gz -C ./</code></p>
<p>2.在 <code>elasticsearch</code> 下新建 data 文件夹 数据目录</p>
<p>​                                            logs 日志目录 </p>
<p>3.es配置文件 <code>elasticsearch.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ======================== Elasticsearch Configuration =========================</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> Elasticsearch comes with reasonable defaults for most settings.</span><br><span class="hljs-comment">#       Before you set out to tweak and tune the configuration, make sure you</span><br><span class="hljs-comment">#       understand what are you trying to accomplish and the consequences.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># The primary way of configuring a node is via this file. This template lists</span><br><span class="hljs-comment"># the most important settings you may want to configure for a production cluster.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Please consult the documentation for further information on configuration options:</span><br><span class="hljs-comment"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ---------------------------------- Cluster -----------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Use a descriptive name for your cluster:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">tho-elasticsearch</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ------------------------------------ Node ------------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Use a descriptive name for the node:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">es-node1</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Add custom attributes to the node:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#node.attr.rack: r1</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ----------------------------------- Paths ------------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Path to directory where to store the data (separate multiple locations by comma):</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">path.data:</span> <span class="hljs-string">/usr/local/elasticsearch/elasticsearch-7.15.2/data</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Path to log files:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">path.logs:</span> <span class="hljs-string">/usr/local/elasticsearch/elasticsearch-7.15.2/logs</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ----------------------------------- Memory -----------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Lock the memory on startup:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#bootstrap.memory_lock: true</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Make sure that the heap size is set to about half the memory available</span><br><span class="hljs-comment"># on the system and that the owner of the process is allowed to use this</span><br><span class="hljs-comment"># limit.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Elasticsearch performs poorly when the system is swapping the memory.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ---------------------------------- Network -----------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># By default Elasticsearch is only accessible on localhost. Set a different</span><br><span class="hljs-comment"># address here to expose this node on the network:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># By default Elasticsearch listens for HTTP traffic on the first free port it</span><br><span class="hljs-comment"># finds starting at 9200. Set a specific HTTP port here:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#http.port: 9200</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># For more information, consult the network module documentation.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># --------------------------------- Discovery ----------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Pass an initial list of hosts to perform discovery when this node is started:</span><br><span class="hljs-comment"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#discovery.seed_hosts: [&quot;host1&quot;, &quot;host2&quot;]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bootstrap the cluster using an initial set of master-eligible nodes:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">cluster.initial_master_nodes:</span> [<span class="hljs-string">&quot;es-node1&quot;</span>]<br><span class="hljs-comment">#</span><br><span class="hljs-comment"># For more information, consult the discovery and cluster formation module documentation.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ---------------------------------- Various -----------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Require explicit names when deleting indices:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#action.destructive_requires_name: true</span><br><br></code></pre></td></tr></table></figure>

<p>4.配置文件 <code>jvm.options</code></p>
<blockquote>
<p>修改  根据机器配置来选择 </p>
<p>​    -Xms128m<br>​    -Xmx128m</p>
</blockquote>
<p>5.es不允许root用户进行操作,要新创建用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">useradd esuser<br><br>进入 es文件夹<br>[root<span class="hljs-meta">@centos_7_100</span> elasticsearch-<span class="hljs-number">7.15</span><span class="hljs-number">.2</span>]# pwd<br>/usr/local/elasticsearch/elasticsearch-<span class="hljs-number">7.15</span><span class="hljs-number">.2</span> <br><br>chown -R esuser /usr/local/elasticsearch/elasticsearch-<span class="hljs-number">7.15</span><span class="hljs-number">.2</span><br>  <br>[root<span class="hljs-meta">@centos_7_100</span> elasticsearch-<span class="hljs-number">7.15</span><span class="hljs-number">.2</span>]# ll<br>总用量 <span class="hljs-number">636</span><br>drwxr-xr-x.  <span class="hljs-number">2</span> esuser root   <span class="hljs-number">4096</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:08 bin<br>drwxr-xr-x.  <span class="hljs-number">3</span> esuser root    <span class="hljs-number">169</span> <span class="hljs-number">11</span>月 <span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">17</span> config<br>drwxr-xr-x.  <span class="hljs-number">2</span> esuser root      <span class="hljs-number">6</span> <span class="hljs-number">11</span>月 <span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">28</span> data<br>drwxr-xr-x.  <span class="hljs-number">9</span> esuser root    <span class="hljs-number">121</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:08 jdk<br>drwxr-xr-x.  <span class="hljs-number">3</span> esuser root   <span class="hljs-number">4096</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:08 lib<br>-rw-r--r--.  <span class="hljs-number">1</span> esuser root   <span class="hljs-number">3860</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:<span class="hljs-number">02</span> LICENSE.txt<br>drwxr-xr-x.  <span class="hljs-number">2</span> esuser root      <span class="hljs-number">6</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:<span class="hljs-number">06</span> logs<br>drwxr-xr-x. <span class="hljs-number">60</span> esuser root   <span class="hljs-number">4096</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:08 modules<br>-rw-r--r--.  <span class="hljs-number">1</span> esuser root <span class="hljs-number">628969</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:<span class="hljs-number">06</span> NOTICE.txt<br>drwxr-xr-x.  <span class="hljs-number">2</span> esuser root      <span class="hljs-number">6</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:<span class="hljs-number">06</span> plugins<br>-rw-r--r--.  <span class="hljs-number">1</span> esuser root   <span class="hljs-number">2710</span> <span class="hljs-number">11</span>月  <span class="hljs-number">4</span> <span class="hljs-number">22</span>:<span class="hljs-number">02</span> README.asciidoc<br><br></code></pre></td></tr></table></figure>

<p>6.进入 es bin目录 切换user <code>sudo esuser</code> 执行命令  <code>./elasticsearch</code></p>
<p>7.报错 处理</p>
<blockquote>
<p>ERROR: [3] bootstrap checks failed. You must address the points described in the following [3] lines before starting Elasticsearch.<br>bootstrap check failure [1] of [3]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]<br>bootstrap check failure [2] of [3]: max number of threads [3795] for user [esuser] is too low, increase to at least [4096]<br>bootstrap check failure [3] of [3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p>
</blockquote>
<p>8.<code>/etc/security</code> 目录下 <code>limits.conf</code> 修改该配置文件</p>
<p>其中加如下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">* soft nofile <span class="hljs-number">65536</span><br>* hard nofile <span class="hljs-number">131072</span><br>* soft nproc <span class="hljs-number">2048</span><br>* soft nproc <span class="hljs-number">4096</span><br></code></pre></td></tr></table></figure>

<ol start="9">
<li><code>/etc</code> 下 修改  sysctl.conf</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">vm.max_map_count=<span class="hljs-number">262144</span><br></code></pre></td></tr></table></figure>

<p><code>su esuser</code> <code>su root</code> 切换用户</p>
<blockquote>
<p>bin目录下运行 <code>./elasticsearch</code></p>
</blockquote>
<p>10.开启 9200 9300 端口</p>
<ol start="11">
<li> <code>./elasticsearch -d </code> 后台运行</li>
<li><code>jps</code> 命令 查看es进程信息</li>
</ol>
<h2 id="1-4、ES可视化工具"><a href="#1-4、ES可视化工具" class="headerlink" title="1.4、ES可视化工具"></a>1.4、ES可视化工具</h2><blockquote>
<p>elasticsearch-head</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
</blockquote>
<p>1.使用chrome 扩展程序 插件</p>
<p>2.使用 本地服务来启动 es-head</p>
<blockquote>
<h4 id="Running-with-built-in-server"><a href="#Running-with-built-in-server" class="headerlink" title="Running with built in server"></a>Running with built in server</h4><ul>
<li><p><code>git clone git://github.com/mobz/elasticsearch-head.git</code></p>
</li>
<li><p><code>cd elasticsearch-head</code></p>
</li>
<li><p><code>npm install</code></p>
</li>
<li><p><code>npm run start</code></p>
</li>
<li><p><code>open</code> <a target="_blank" rel="noopener" href="http://localhost:9100/">http://localhost:9100/</a></p>
</li>
</ul>
<p>This will start a local webserver running on port 9100 serving elasticsearch-head</p>
</blockquote>
<p>配置es跨域</p>
<p>elasticsearch.yml 配置文件修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">http.cors.enabled: <span class="hljs-keyword">true</span><br>http.cors.allow-origin: <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure>

<h1 id="二、ElasticSearch基本使用"><a href="#二、ElasticSearch基本使用" class="headerlink" title="二、ElasticSearch基本使用"></a>二、ElasticSearch基本使用</h1><h2 id="2-1、head插件基本操作"><a href="#2-1、head插件基本操作" class="headerlink" title="2.1、head插件基本操作"></a>2.1、head插件基本操作</h2><blockquote>
<p>可以用可视化操作es ，也可以用postman 直接调用接口来操作es</p>
</blockquote>
<h2 id="2-2、mappings映射"><a href="#2-2、mappings映射" class="headerlink" title="2.2、mappings映射"></a>2.2、mappings映射</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JSON">&#123;<br>    <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;realname&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-literal">true</span><br>            &#125;,<br>            <span class="hljs-attr">&quot;username&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-literal">false</span><br>            &#125;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>text 类型会分词</p>
<p>keyword 类型无需分词,是精确的,精确匹配</p>
</blockquote>
<blockquote>
<p>mappings 查看分词效果</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JSON">text 类型<br>http:<span class="hljs-comment">//192.168.198.100:9200/index_mapping/_analyze</span><br>&#123;<br>    <span class="hljs-attr">&quot;field&quot;</span>: <span class="hljs-string">&quot;realname&quot;</span>,<br>    <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span><br>&#125;<br>返回消息体<br>&#123;<br>    <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;hello&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">5</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;&lt;ALPHANUM&gt;&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;world&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">6</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">11</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;&lt;ALPHANUM&gt;&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">1</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JSON">keyword类型<br>http:<span class="hljs-comment">//192.168.198.100:9200/index_mapping/_analyze</span><br>&#123;<br>    <span class="hljs-attr">&quot;field&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,<br>    <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span><br>&#125;<br>返回消息体<br>&#123;<br>    <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">11</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;word&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>索引的类型一旦确定,是不能修改的</p>
</blockquote>
<blockquote>
<p>已存在mappings 增加新的mappings 字段</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">http:<span class="hljs-comment">//192.168.198.100:9200/index_mapping/_mapping</span><br>&#123;<br>    <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;id&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>            &#125;,<br>            <span class="hljs-attr">&quot;age&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>            &#125;<br><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>主要数据类型</p>
<ul>
<li>text , keyword</li>
<li>long, integer, short, byte</li>
<li>double, float</li>
<li>boolean</li>
<li>date</li>
<li>object</li>
<li>数组不能混,类型一致</li>
</ul>
</blockquote>
<h2 id="2-3、文档基本操作"><a href="#2-3、文档基本操作" class="headerlink" title="2.3、文档基本操作"></a>2.3、文档基本操作</h2><blockquote>
<ul>
<li>_index: 文档数据所属那个索引,理解为数据库的某张表即可。</li>
<li>_type: 文档数据属于哪个类型，新版本使用   _doc</li>
<li>_id: 文档数据的唯一标识，类似数据库中某张表的主键，可以自动生成或手动指定</li>
<li>_score: 查询相关度，是否契合用户匹配，分数越高用户的搜索体验越高</li>
<li>_version: 版本号</li>
<li>_source: 文档数据，json格式</li>
</ul>
</blockquote>
<blockquote>
<p>添加文档</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/1  // 数字1代表此条记录在es索引中的id信息</span><br>&#123;																								<span class="hljs-comment">// 此参数不写 es 会自动生成一个id</span><br>    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1001</span>,   <span class="hljs-comment">// 这个 “id” 信息表示在mysql等数据库中的id信息</span><br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;tho-1&quot;</span>,<br>    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;hello world！&quot;</span>,<br>    <span class="hljs-attr">&quot;create_date&quot;</span>: <span class="hljs-string">&quot;2021-11-27&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>文档的删除和修改</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JSON">DELETE http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/9</span><br><span class="hljs-comment">// 返回值body</span><br>&#123;<br>    <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;9&quot;</span>,<br>    <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;deleted&quot;</span>,<br>    <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-comment">// 多次删除同一个文档记录,_version 会累加,result 会显示 not_found</span><br><span class="hljs-comment">// 此时删除是逻辑删除,当磁盘空间紧张时,才会真正物理上的删除</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>文档修改-局部修改</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/1/_update // 1为es中文档记录的id</span><br><span class="hljs-comment">// 局部修改 只修改了传的参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;doc&quot;</span>: &#123;<br>        <span class="hljs-comment">// 要修改的字段信息</span><br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;tho-778&quot;</span>       <br>    &#125;<br>&#125;<br><span class="hljs-comment">// 返回消息体</span><br>&#123;<br>    <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>    <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>文档修改-全部修改</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JSON">PUT http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/1</span><br>&#123;<br>    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1066</span>,<br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;thottt&quot;</span>,<br>    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;tho world 9&quot;</span>,<br>    <span class="hljs-attr">&quot;create_date&quot;</span>: <span class="hljs-string">&quot;2021-11-26&quot;</span><br>&#125;<br><span class="hljs-comment">// 返回消息体</span><br>&#123;<br>    <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>    <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">13</span>,<br>    <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>文档查询</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JSON">GET http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/1</span><br><span class="hljs-comment">// 返回消息体</span><br>&#123;<br>    <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>    <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">13</span>,<br>    <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1066</span>,<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;thottt&quot;</span>,<br>        <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;tho world 9&quot;</span>,<br>        <span class="hljs-attr">&quot;create_date&quot;</span>: <span class="hljs-string">&quot;2021-11-26&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>查询所有文档数据</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON">GET http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/_search</span><br><span class="hljs-comment">// 查询指定字段</span><br>GET http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/1?_source=id,name </span><br><span class="hljs-comment">// 判断一个记录是否存在  返回状态码是 200 存在该记录</span><br><span class="hljs-comment">// 																	404 不存在该记录</span><br>HEAD http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/5</span><br></code></pre></td></tr></table></figure>

<h2 id="2-4、ES乐观锁"><a href="#2-4、ES乐观锁" class="headerlink" title="2.4、ES乐观锁"></a>2.4、ES乐观锁</h2><blockquote>
<p>基于 _seq_no 字段 和 _primary_term 字段</p>
<ul>
<li>_seq_no             序列号,类似 version版本号</li>
<li>_primary_term   表示该记录所在分片的标识</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_doc/2001/_update?if_seq_no=16&amp;if_primary_term=1</span><br><span class="hljs-comment">// 对应的if_seq_no if_primary_term 要正确,否则不能完成修改</span><br></code></pre></td></tr></table></figure>

<h2 id="2-5、ES分词器"><a href="#2-5、ES分词器" class="headerlink" title="2.5、ES分词器"></a>2.5、ES分词器</h2><h3 id="1、ES分词基础概念"><a href="#1、ES分词基础概念" class="headerlink" title="1、ES分词基础概念"></a>1、ES分词基础概念</h3><blockquote>
<p>分词：把文本转换为一个个单词,分词成为analysis。es默认只对英文语句做分词，中文不支持，每个中文字都会被拆分为独立的个体</p>
</blockquote>
<ul>
<li>es内置分词器</li>
</ul>
<blockquote>
<p>standard：默认分词，单词会被拆分。大写会转换为小写</p>
<p>simple：按照非字母分词，大写转换为小写</p>
<p>whitespace：按照空格分词，忽略大小写</p>
<p>stop：去除无意义单词，比如 the/is/an/a …</p>
<p>keyword：不做分词，把整个文本作为一个单独的关键字</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_analyze</span><br><span class="hljs-comment">// 返回消息体</span><br>&#123;<br>    <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;hello&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">5</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;&lt;ALPHANUM&gt;&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;world&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">6</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">11</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;&lt;ALPHANUM&gt;&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">1</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="2、建立ik中文分词器"><a href="#2、建立ik中文分词器" class="headerlink" title="2、建立ik中文分词器"></a>2、建立ik中文分词器</h3><blockquote>
<p>elasticsearch-analysis-ik-7.15.2 对应es的版本</p>
<p>环境配置</p>
<ol>
<li>ik_max_word 和 ik_smart 有什么区别？</li>
</ol>
<p>ik_max_word: 泡沫文本做最细粒度的分裂，中华爱国“中华人民共和国国歌”分裂为中华人民共和国“，和、国国、国歌”，会穷尽各种可能的组合，适合词条查询；</p>
<p>ik_smart：会做最粗粒度的拆分，比如“中华人民共和国国歌”拆分为“中华人民共和国，国歌”，适合短语查询。</p>
</blockquote>
<p>1.解压到elasticsearch 下 plugins 下 的 ik文件夹下</p>
<p><code>unzip elasticsearch-analysis-ik-7.15.2.zip -d /usr/local/elasticsearch/elasticsearch-7.15.2/plugins/ik/</code></p>
<p>2.重启es即可生效</p>
<p>3.测试</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/my_doc/_analyze</span><br><span class="hljs-comment">// 参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>    <span class="hljs-attr">&quot;field&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span>,<br>    <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;上下班车流量很大&quot;</span><br>&#125;<br><span class="hljs-comment">// 返回结果体</span><br>&#123;<br>    <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;上下班&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">3</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;上下&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;下班&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">3</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">2</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;班车&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">4</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">3</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;车流量&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">3</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">6</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">4</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;车流&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">3</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">5</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">5</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;流量&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">4</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">6</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">6</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;token&quot;</span>: <span class="hljs-string">&quot;很大&quot;</span>,<br>            <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">6</span>,<br>            <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">8</span>,<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>            <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">7</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3、自定义中文词库"><a href="#3、自定义中文词库" class="headerlink" title="3、自定义中文词库"></a>3、自定义中文词库</h3><ul>
<li>配置文件路径</li>
</ul>
<p><code>/usr/local/elasticsearch/elasticsearch-7.15.2/plugins/ik/config</code> 下的 <code>IKAnalyzer.cfg.xml</code></p>
<p>1.config 目录下新建词库文件 custom.dic 内容为要配置的中文词汇</p>
<p>2.配置文件<code>IKAnalyzer.cfg.xml</code> 修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">properties</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_dict&quot;</span>&gt;</span>custom.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>	 <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br>	<span class="hljs-comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br>	<span class="hljs-comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>3.重启es</p>
<blockquote>
<p>之后再进行分词,custom.dic 中的中文词汇会被自动进行分词</p>
</blockquote>
<h1 id="三、DSL搜索"><a href="#三、DSL搜索" class="headerlink" title="三、DSL搜索"></a>三、DSL搜索</h1><h2 id="3-1、数据准备"><a href="#3-1、数据准备" class="headerlink" title="3.1、数据准备"></a>3.1、数据准备</h2><blockquote>
<p>词库 建立索引  手动建立 mappings</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_mapping</span><br>&#123;<br>    <span class="hljs-attr">&quot;properties&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;id&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;long&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;age&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;username&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;nickname&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-attr">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;money&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;float&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;desc&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-attr">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;sex&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;byte&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;birthday&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;date&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;face&quot;</span>:&#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-attr">&quot;index&quot;</span>:<span class="hljs-literal">false</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>录入数据记录</p>
</blockquote>
<h2 id="3-2、DSL入门语法"><a href="#3-2、DSL入门语法" class="headerlink" title="3.2、DSL入门语法"></a>3.2、DSL入门语法</h2><blockquote>
<p>QueryString方式</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// 基本查询</span><br>GET http:<span class="hljs-comment">//192.168.198.100:9200/tho/_search?q=desc:慕课网 </span><br><span class="hljs-comment">// 该查询查询条件是 desc:慕课网</span><br><br><br><span class="hljs-comment">// 多条件查询</span><br>GET http:<span class="hljs-comment">//192.168.198.100:9200/tho/_search?q=desc:慕课网&amp;q=age:18</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>DSL搜索</p>
<p>QueryString用的很少，一旦参数复杂就难以构建，所以大多数都会使用DSL来进行查询</p>
<ul>
<li>Domain Specific Language</li>
<li>特定领域语言</li>
<li>基于JSON格式的数据查询</li>
<li>查询更灵活，有利于复杂查询</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// DSL搜索</span><br>POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_doc/_search</span><br><span class="hljs-comment">// 请求体</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;慕课网&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 查询某字段是否存在</span><br><span class="hljs-comment">// 请求体</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;exists&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;field&quot;</span>: <span class="hljs-string">&quot;username&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 查询所有记录</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match_all&quot;</span>: &#123;<br>            <br>        &#125;<br>    &#125;<br>&#125; <br><br><span class="hljs-comment">// 选择查询的字段 id nickname age</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match_all&quot;</span>: &#123;<br>            <br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;age&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// 分页</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match_all&quot;</span>: &#123;<br>            <br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;age&quot;</span><br>    ],<br>    <span class="hljs-attr">&quot;from&quot;</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">5</span><br>&#125;<br><br><span class="hljs-comment">// term  精确搜索 查询关键字不会被分词处理</span><br><span class="hljs-comment">// match 分词搜索 查询关键字会被分词处理</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>:<span class="hljs-string">&quot;百度&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;term&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>:<span class="hljs-string">&quot;百度搜索&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// terms 多个词语匹配检索</span><br><span class="hljs-comment">// 类似于标签,会进行多个词语的检索</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: [<span class="hljs-string">&quot;百度搜索&quot;</span>,<span class="hljs-string">&quot;打游戏&quot;</span>]<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// match_phrase：分词结果必须在text字段分词中都包含，而且顺序必须相同，而且必须都是连续的。（搜索比较严格）</span><br><span class="hljs-comment">// 字段内容必须是 百度搜索es</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match_phrase&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;百度搜索 es&quot;</span><br>                <span class="hljs-string">&quot;slop&quot;</span>: <span class="hljs-number">5</span> <span class="hljs-comment">// slop 允许中间跳过字符的数量来匹配</span><br>            &#125;<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// and or 运算符</span><br><span class="hljs-comment">// minimum_should_match 匹配程度达到多少以上才会显示</span><br><span class="hljs-comment">//	&quot;minimum_should_match&quot;:&quot;60%&quot; 10个分词 6个以上匹配才会显示</span><br><span class="hljs-comment">// 	&quot;minimum_should_match&quot;:&quot;3&quot;    3个以上分词匹配才会显示</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;慕课网 游泳&quot;</span>,<br>                <span class="hljs-attr">&quot;operator&quot;</span>: <span class="hljs-string">&quot;or&quot;</span>,<br>                <span class="hljs-attr">&quot;minimum_should_match&quot;</span>:<span class="hljs-string">&quot;100%&quot;</span><br>            &#125;<br>        &#125; <br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// DSL方式根据id查询</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;ids&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>            <span class="hljs-attr">&quot;values&quot;</span>:[<span class="hljs-string">&quot;1001&quot;</span>,<span class="hljs-string">&quot;1003&quot;</span>,<span class="hljs-string">&quot;1009&quot;</span>]<br>        &#125; <br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// multi_match 满足使用match 在多个字段中进行查询的需求</span><br><span class="hljs-comment">// 多个字段 其中有满足 query 条件的就会被查询出来</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;multi_match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;游泳 慕课网&quot;</span>,<br>            <span class="hljs-attr">&quot;fields&quot;</span>:[<span class="hljs-string">&quot;desc&quot;</span>,<span class="hljs-string">&quot;nickname&quot;</span>]<br>        &#125; <br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><span class="hljs-comment">// &quot;nickname^10&quot; 提升某个字段的权重</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;multi_match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;游泳 慕课网&quot;</span>,<br>            <span class="hljs-attr">&quot;fields&quot;</span>:[<br>                <span class="hljs-string">&quot;desc&quot;</span>,<span class="hljs-string">&quot;nickname^10&quot;</span><br>            ]<br>        &#125; <br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">// DSL 布尔查询 多条件查询</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br>          	<span class="hljs-comment">// &quot;must&quot; 下面条件都是 and</span><br>          	<span class="hljs-comment">// &quot;should&quot; 下面条件都是 or</span><br>          	<span class="hljs-comment">// &quot;must_not&quot; 下面条件都不满足(都是非)</span><br>            <span class="hljs-attr">&quot;must&quot;</span>: [<br>              <span class="hljs-comment">// 条件1</span><br>                &#123; <span class="hljs-attr">&quot;multi_match&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;query&quot;</span>:<span class="hljs-string">&quot;百度&quot;</span>,<br>                    <span class="hljs-attr">&quot;fields&quot;</span>: [<br>                        <span class="hljs-string">&quot;desc&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span><br>                    ]<br>                    &#125;<br>                &#125;,<br>              <span class="hljs-comment">// 条件2 and 条件</span><br>                &#123;<br>                    <span class="hljs-attr">&quot;term&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">1</span><br>                    &#125;<br>                &#125;  <br>            ]<br>            <br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br><span class="hljs-comment">// 条件组合查询</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br>            <br>            <span class="hljs-attr">&quot;should&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;ns&quot;</span><br>                    &#125;<br>                &#125;,&#123;<br>                    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;百度搜索&quot;</span><br>                    &#125;<br>                &#125;<br>            ],<br>            <span class="hljs-attr">&quot;must&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;百度&quot;</span><br>                    &#125;<br>                &#125;<br>            ],<br>            <span class="hljs-attr">&quot;must_not&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;巨硬&quot;</span><br>                    &#125;<br>                &#125;<br>            ]<br>            <br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;_source&quot;</span>: [<br>        <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="3-3、DSL查询-布尔查询"><a href="#3-3、DSL查询-布尔查询" class="headerlink" title="3.3、DSL查询-布尔查询"></a>3.3、DSL查询-布尔查询</h2><blockquote>
<ul>
<li>must：查询必须匹配搜索条件，相当于 and</li>
<li>should：查询匹配满足1个以上条件，相当于or</li>
<li>must_not：不匹配搜索条件，一个都不要满足</li>
</ul>
</blockquote>
<h2 id="3-4、DSL高级查询"><a href="#3-4、DSL高级查询" class="headerlink" title="3.4、DSL高级查询"></a>3.4、DSL高级查询</h2><blockquote>
<p>过滤器</p>
<p>对搜索出来的结果进行数据过滤。不会到es库里去搜，不会去计算文档的相关度分数，所以过滤的性能会比较高，过滤器可以和全文搜索结合在一起使用。 post_filter元素是一个顶层元素，只会对搜索结果进行过滤。不会计算数据的匹配度相关性分数，不会根据分数去排序，query则相反，会计算分数，也会按照分数进行显示</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// 根据money进行过滤</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;百度搜索&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;post_filter&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;range&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;money&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;gt&quot;</span>: <span class="hljs-number">60</span>,<br>                <span class="hljs-attr">&quot;lt&quot;</span>: <span class="hljs-number">1000</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>排序</p>
<p>keyword 类型可以进行排序</p>
<p>对文本进行排序</p>
<ul>
<li>由于文本会被分词，所以往往要去做排序会报错，通常我们可以为这个字段增加额外的一个附属属性，类型为keyword，用于做排序。</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// 指定某个字段及其对应的排序规则</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;百度搜索&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;sort&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">// 根据keyword来进行排序</span><br><span class="hljs-comment">// 某个字段的附属属性 keyword来进行排序</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;sort&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;name.keyword&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>搜索结果高亮</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JSON">&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;谷歌&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;highlight&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;pre_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;span&gt;&quot;</span>], <span class="hljs-comment">//自定义标签 &lt;span&gt;&lt;/span&gt;</span><br>        <span class="hljs-attr">&quot;post_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>],<span class="hljs-comment">// 默认标签 &lt;em&gt;&lt;/em&gt;</span><br>        <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;desc&quot;</span>: &#123;&#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>进阶</p>
<ul>
<li><p>prefix  根据前缀去查询</p>
</li>
<li><p>fuzzy    模糊搜索，并不是sql的模糊搜索，而是在用户进行搜索时打字错误，搜索引擎会自动更正，然后尝试匹配索引数据库中的数据</p>
</li>
<li><p>wildcard  占位符查询</p>
<p>  ？：1个字符</p>
<p>  *：1个或多个字符</p>
</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// prefix</span><br>&#123;<br>	<span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>			<span class="hljs-attr">&quot;prefix&quot;</span>: &#123;<br>					<span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;imo&quot;</span><br>			 &#125;<br>	&#125;<br>&#125;<br><span class="hljs-comment">// fuzzy</span><br>&#123;<br>		<span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>				<span class="hljs-attr">&quot;multi_match&quot;</span>: &#123;<br>						<span class="hljs-attr">&quot;fields&quot;</span>: [ <span class="hljs-string">&quot;desc&quot;</span>, <span class="hljs-string">&quot;nickname&quot;</span>],<br>						 <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;imcoc supor&quot;</span>,<br>						  <span class="hljs-attr">&quot;fuzziness&quot;</span>: <span class="hljs-string">&quot;AUTO&quot;</span><br>			 	&#125;<br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="四、ES进阶使用"><a href="#四、ES进阶使用" class="headerlink" title="四、ES进阶使用"></a>四、ES进阶使用</h1><h2 id="4-1、ES深度分页"><a href="#4-1、ES深度分页" class="headerlink" title="4.1、ES深度分页"></a>4.1、ES深度分页</h2><h3 id="1-限制分页深度"><a href="#1-限制分页深度" class="headerlink" title="1.限制分页深度"></a>1.限制分页深度</h3><blockquote>
<p>分页查询</p>
<p>查询深度过深性能会很差</p>
<ul>
<li>限制分页页数</li>
</ul>
<p>​    在es中获取9999条数据到10009条数据的时候，其实每个分片都会拿到10009条数据，然后集合在一起，总共是10009*3=30027条数据，针对30027条数据再次做排序，获取最后的10条数据</p>
<p>​    如此一来，搜索地太深，就会造成性能问题，会耗费内存和占用CPU。而且es为了性能，不支持超过一万条数据以上的分页查询。为了避免深度分页问题，要限制分页页数，每页展示100条数据，最多提供100页的展示，从101页开始就没了，用户也不会搜索需要100页，淘宝的分页限制就是100页</p>
</blockquote>
<h3 id="2-设置分页查询最大值"><a href="#2-设置分页查询最大值" class="headerlink" title="2.设置分页查询最大值"></a>2.设置分页查询最大值</h3><blockquote>
<p>还可以通过设置es参数来突破分页查询数据的限制</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// 查询es的各项设置</span><br>GET http:<span class="hljs-comment">//192.168.198.100:9200/tho/_settings</span><br>&#123;<br>    <span class="hljs-attr">&quot;tho&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;settings&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;routing&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;allocation&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;include&quot;</span>: &#123;<br>                            <span class="hljs-attr">&quot;_tier_preference&quot;</span>: <span class="hljs-string">&quot;data_content&quot;</span><br>                        &#125;<br>                    &#125;<br>                &#125;,<br>                <span class="hljs-attr">&quot;number_of_shards&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>                <span class="hljs-attr">&quot;provided_name&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;creation_date&quot;</span>: <span class="hljs-string">&quot;1638000752374&quot;</span>,<br>                <span class="hljs-attr">&quot;number_of_replicas&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>                <span class="hljs-attr">&quot;uuid&quot;</span>: <span class="hljs-string">&quot;LPZF8yR-SaGfPVOCdXOtCg&quot;</span>,<br>                <span class="hljs-attr">&quot;version&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-string">&quot;7150299&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 设置查询限制</span><br>PUT http:<span class="hljs-comment">//192.168.198.100:9200/tho/_settings</span><br><span class="hljs-comment">// 参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;index.max_result_window&quot;</span>: <span class="hljs-number">16666</span><br>&#125;<br><span class="hljs-comment">// 再次查询</span><br>&#123;<br>    <span class="hljs-attr">&quot;tho&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;settings&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;routing&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;allocation&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;include&quot;</span>: &#123;<br>                            <span class="hljs-attr">&quot;_tier_preference&quot;</span>: <span class="hljs-string">&quot;data_content&quot;</span><br>                        &#125;<br>                    &#125;<br>                &#125;,<br>                <span class="hljs-attr">&quot;number_of_shards&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>                <span class="hljs-attr">&quot;provided_name&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;max_result_window&quot;</span>: <span class="hljs-string">&quot;16666&quot;</span>, <span class="hljs-comment">// 分页显示数量</span><br>                <span class="hljs-attr">&quot;creation_date&quot;</span>: <span class="hljs-string">&quot;1638000752374&quot;</span>,<br>                <span class="hljs-attr">&quot;number_of_replicas&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>                <span class="hljs-attr">&quot;uuid&quot;</span>: <span class="hljs-string">&quot;LPZF8yR-SaGfPVOCdXOtCg&quot;</span>,<br>                <span class="hljs-attr">&quot;version&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-string">&quot;7150299&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-2、滚动搜索scroll"><a href="#4-2、滚动搜索scroll" class="headerlink" title="4.2、滚动搜索scroll"></a>4.2、滚动搜索scroll</h2><blockquote>
<p>  一次查询1w+数据，往往会造成性能影响，因为数据量太大了，这个时候可以使用滚动搜索，也就是 <code>scroll</code> 。滚动搜索可以先查询出一些数据，然后再紧接着依次往下查询。在第一次查询的时候会有一个滚动id，相当于一个 <code>锚标记</code>，随后再次滚动搜索会需要上一次搜索的 锚标记，根据这个进行下一次搜索请求，每次搜索都是基于一个历史的数据快照，查询数据的期间，如果有数据的变更，那么和搜索是没有关系的，搜索的内容还是快照里的</p>
<ul>
<li>scroll=1m, 相当于是一个session会话时间，搜索保持的上下文时间为1分钟</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// 滚动搜索 第一次搜索</span><br>POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_search?scroll=1m </span><br><span class="hljs-comment">// 会话有效期1分钟,要在1分钟内进行下一次查询</span><br><span class="hljs-comment">// 参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;match_all&quot;</span>: &#123;&#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;sort&quot;</span>: [<span class="hljs-string">&quot;_doc&quot;</span>],<br>    <span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">5</span><br>&#125;<br><span class="hljs-comment">// 返回消息体</span><br>&#123;<br>    <span class="hljs-attr">&quot;_scroll_id&quot;</span>: <span class="hljs-string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDnF1ZXJ5VGhlbkZldGNoAxYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAACsWNUV4Sk91My1TR1cyRWdibmZjQmhiQRYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAACwWNUV4Sk91My1TR1cyRWdibmZjQmhiQRYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAAC0WNUV4Sk91My1TR1cyRWdibmZjQmhiQQ==&quot;</span>,<br>    <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">76</span>,<br>    <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">3</span>,<br>        <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">3</span>,<br>        <span class="hljs-attr">&quot;skipped&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;total&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">16</span>,<br>            <span class="hljs-attr">&quot;relation&quot;</span>: <span class="hljs-string">&quot;eq&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-literal">null</span>,<br>        <span class="hljs-attr">&quot;hits&quot;</span>: [<br>            &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1002&quot;</span>,<br>                <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1002</span>,<br>                    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">20</span>,<br>                    <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;bigFace&quot;</span>,<br>                    <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;飞翔的巨硬&quot;</span>,<br>                    <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;6.8&quot;</span>,<br>                    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;去了海外&quot;</span>,<br>                    <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;2000-06-26&quot;</span>,<br>                    <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com&quot;</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;sort&quot;</span>: [<br>                    <span class="hljs-number">0</span><br>                ]<br>            &#125;,<br>            &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1001&quot;</span>,<br>                <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1001</span>,<br>                    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">18</span>,<br>                    <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;imoocAmazing&quot;</span>,<br>                    <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;百度搜索&quot;</span>,<br>                    <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;88.8&quot;</span>,<br>                    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;学习java和前端&quot;</span>,<br>                    <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                    <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;1999-06-26&quot;</span>,<br>                    <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com&quot;</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;sort&quot;</span>: [<br>                    <span class="hljs-number">0</span><br>                ]<br>            &#125;,<br>            &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1003&quot;</span>,<br>                <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1003</span>,<br>                    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">22</span>,<br>                    <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;flyfish&quot;</span>,<br>                    <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;鱼&quot;</span>,<br>                    <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;6.8&quot;</span>,<br>                    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;池塘里，游泳&quot;</span>,<br>                    <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                    <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;2000-06-26&quot;</span>,<br>                    <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com1&quot;</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;sort&quot;</span>: [<br>                    <span class="hljs-number">1</span><br>                ]<br>            &#125;,<br>            &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1004&quot;</span>,<br>                <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1004</span>,<br>                    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">21</span>,<br>                    <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;gotoplay&quot;</span>,<br>                    <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;ns&quot;</span>,<br>                    <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;6.88&quot;</span>,<br>                    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;打游戏&quot;</span>,<br>                    <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                    <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;2000-06-26&quot;</span>,<br>                    <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com1&quot;</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;sort&quot;</span>: [<br>                    <span class="hljs-number">1</span><br>                ]<br>            &#125;,<br>            &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1007&quot;</span>,<br>                <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1007</span>,<br>                    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">21</span>,<br>                    <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;gotorun&quot;</span>,<br>                    <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;ns&quot;</span>,<br>                    <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;6.88&quot;</span>,<br>                    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;跑步ask法拉盛克里夫&quot;</span>,<br>                    <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                    <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;2000-06-26&quot;</span>,<br>                    <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com1&quot;</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;sort&quot;</span>: [<br>                    <span class="hljs-number">2</span><br>                ]<br>            &#125;<br>        ]<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// 滚动查询 之后的查询 (要在设置的会话有效期内进行后续查询)</span><br>POST http:<span class="hljs-comment">//192.168.198.100:9200/_search/scroll</span><br><span class="hljs-comment">// 参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;scroll_id&quot;</span>: <span class="hljs-string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDnF1ZXJ5VGhlbkZldGNoAxYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAAC4WNUV4Sk91My1TR1cyRWdibmZjQmhiQRYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAADAWNUV4Sk91My1TR1cyRWdibmZjQmhiQRYxZWZTaUxORVRVUzBKOVo0bzRFVENBAAAAAAAAAC8WNUV4Sk91My1TR1cyRWdibmZjQmhiQQ==&quot;</span>,<br>    <span class="hljs-attr">&quot;scroll&quot;</span>: <span class="hljs-string">&quot;1m&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-3、批量查询"><a href="#4-3、批量查询" class="headerlink" title="4.3、批量查询"></a>4.3、批量查询</h2><h3 id="1-mget批量查询"><a href="#1-mget批量查询" class="headerlink" title="1.mget批量查询"></a>1.mget批量查询</h3><blockquote>
<p>获取多个查询</p>
<p>查询不存在的记录也会显示出来</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_doc/_mget</span><br><span class="hljs-comment">// 参数</span><br>&#123;<br>    <span class="hljs-attr">&quot;ids&quot;</span>: [<span class="hljs-string">&quot;1001&quot;</span>, <span class="hljs-string">&quot;1003&quot;</span>]<br>&#125;<br><span class="hljs-comment">// 返回值</span><br>&#123;<br>    <span class="hljs-attr">&quot;docs&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>            <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>            <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1001&quot;</span>,<br>            <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1001</span>,<br>                <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">18</span>,<br>                <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;imoocAmazing&quot;</span>,<br>                <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;百度&quot;</span>,<br>                <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;88.8&quot;</span>,<br>                <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;学习java和前端，学到了很多&quot;</span>,<br>                <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;1999-06-26&quot;</span>,<br>                <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com&quot;</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>            <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>            <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1003&quot;</span>,<br>            <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1003</span>,<br>                <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">22</span>,<br>                <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;flyfish&quot;</span>,<br>                <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;水&quot;</span>,<br>                <span class="hljs-attr">&quot;money&quot;</span>: <span class="hljs-string">&quot;6.8&quot;</span>,<br>                <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;池塘里，游泳&quot;</span>,<br>                <span class="hljs-attr">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br>                <span class="hljs-attr">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;2000-06-26&quot;</span>,<br>                <span class="hljs-attr">&quot;face&quot;</span>: <span class="hljs-string">&quot;https://www.tho.com1&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-批量增删改-bulk"><a href="#2-批量增删改-bulk" class="headerlink" title="2.批量增删改-bulk"></a>2.批量增删改-bulk</h3><blockquote>
<p>bulk操作和以往的普通格式有区别，不要格式化json，不然就不在同一行了，需要注意</p>
<p>{ action: { metadata }}\n </p>
<p>{ request body }\n </p>
<p>{ action: { metadata }}\n </p>
<p>{ request body }\n</p>
<ul>
<li>{ action: { metadata }} 代表批量操作的类型，可以是新增、删除或修改</li>
<li> \n 是每行结尾必须填写的一个规范，每一行包括最后一行都要写，用于es的解析</li>
<li> { request body } 是请求body，增加和修改操作需要，删除操作则不需要</li>
</ul>
</blockquote>
<blockquote>
<p>批量操作的类型</p>
<p>action必须是以下选项之一</p>
<ul>
<li>create：如果文档不存在，创建该文档，文档存在会报错，发生异常报错不会影响其它操作</li>
<li>index：创建一个新文档或者替换一个现有的文档</li>
<li>update：部分更新一个文档</li>
<li>delete：删除一个文档</li>
</ul>
<p>metadata中需要指定要操作文档的 _index, _type 和 _id ， _index  _type 也可以在url中指定</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/_bulk</span><br><span class="hljs-comment">// 参数</span><br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;shop2&quot;</span>, <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2001&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2001&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2001&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;shop2&quot;</span>, <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2002&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2002&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2002&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;shop2&quot;</span>, <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2003&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2003&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2003&quot;</span>&#125;<br><span class="hljs-comment">// 返回值</span><br>&#123;<br>    <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">72</span>,<br>    <span class="hljs-attr">&quot;errors&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">&quot;items&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;create&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2001&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">7</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;create&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2002&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">9</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;create&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2003&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">8</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>参数里面的 “ _index “ 和 “ _type “ 都是一样的,可以提取出来</p>
<p>可以放到url里</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_doc/_bulk</span><br><span class="hljs-comment">// 参数</span><br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2005&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2005&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2005&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2006&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2006&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2006&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;create&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2007&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2007&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2007&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-批量操作-index"><a href="#3-批量操作-index" class="headerlink" title="3.批量操作-index"></a>3.批量操作-index</h3><blockquote>
<p>index 不存在的尽量进行导入</p>
<p>存在的记录会被直接覆盖</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST http:<span class="hljs-comment">//192.168.198.100:9200/tho/_doc/_bulk</span><br><span class="hljs-comment">// 参数</span><br>&#123;<span class="hljs-attr">&quot;index&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2005&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2005&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;name2005&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;index&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2006&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2006&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;index&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;index&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2007&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2007&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;index&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;index&quot;</span>: &#123;<span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2008&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2008&quot;</span>, <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;index-new&quot;</span>&#125;<br><span class="hljs-comment">// 返回值</span><br>&#123;<br>    <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">44</span>,<br>    <span class="hljs-attr">&quot;errors&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">&quot;items&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2005&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2006&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">11</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2007&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>, <span class="hljs-comment">// 存在 进行更新</span><br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">12</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;tho&quot;</span>,<br>                <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2008&quot;</span>,<br>                <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>, <span class="hljs-comment">// 不存在,创建新的</span><br>                <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>                &#125;,<br>                <span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">13</span>,<br>                <span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">2</span>,<br>                <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="五、ES集群"><a href="#五、ES集群" class="headerlink" title="五、ES集群"></a>五、ES集群</h1><h2 id="5-1、ES集群基本概念"><a href="#5-1、ES集群基本概念" class="headerlink" title="5.1、ES集群基本概念"></a>5.1、ES集群基本概念</h2><blockquote>
<p>主节点和 备份节点不能放在同一个服务器上</p>
</blockquote>
<blockquote>
<p>查看配置信息</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs SHELL">more elasticsearch.yml | grep ^[^#]<br><br>[esuser@centos_7_100 config]$ more elasticsearch.yml | grep ^[^#]<br>cluster.name: tho-elasticsearch<br>node.name: es-node1<br>path.data: /usr/local/elasticsearch/elasticsearch-7.15.2/data<br>path.logs: /usr/local/elasticsearch/elasticsearch-7.15.2/logs<br>network.host: 0.0.0.0<br>http.cors.enabled: true<br>http.cors.allow-origin: &quot;*&quot;<br>cluster.initial_master_nodes: [&quot;es-node1&quot;]<br><br></code></pre></td></tr></table></figure>

<h2 id="5-2、ES脑裂"><a href="#5-2、ES脑裂" class="headerlink" title="5.2、ES脑裂"></a>5.2、ES脑裂</h2><blockquote>
<p>如果发生网络中断或者服务器宕机，那么集群会有可能被划分为两个部分，各自有自己的master管理，这就是脑裂</p>
</blockquote>
<blockquote>
<p>解决方案</p>
<ul>
<li>master主节点要经过多个master共同选举后才能成为新的主节点，就跟班级里的班长一样，并不是一个人可以决定的，需要班里多数人的决定</li>
<li>解决实现原理：半数以上节点同意，节点方可成为新的master</li>
</ul>
</blockquote>
<ul>
<li><p>discovery.zen.minimum_master_nodes=(N/2)+1</p>
<p>  N为集群的中master节点的数量，也就是那些 node.master=true 设置的那些服务器节点总数。</p>
</li>
</ul>
<blockquote>
<p>新版本ES   ES7.X9</p>
<p><code>minimum_master_node </code> 这个参数已经被移除了，这一块内容完全由es自身去管理，避免了脑裂问题，选举也会非常快</p>
</blockquote>
<h2 id="5-3、ES集群文档读写原理"><a href="#5-3、ES集群文档读写原理" class="headerlink" title="5.3、ES集群文档读写原理"></a>5.3、ES集群文档读写原理</h2><h1 id="六、ES整合SpringBoot"><a href="#六、ES整合SpringBoot" class="headerlink" title="六、ES整合SpringBoot"></a>六、ES整合SpringBoot</h1><h2 id="6-1、引入依赖"><a href="#6-1、引入依赖" class="headerlink" title="6.1、引入依赖"></a>6.1、引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-comment">&lt;!--&lt;version&gt;2.1.5.RELEASE&lt;/version&gt;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>此依赖使用的es版本是 es6.4.3 要将服务器上的es降级为对应版本</p>
</blockquote>
<blockquote>
<p>项目配置文件 application.yml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">spring:</span><br>	<span class="hljs-comment"># 需要datasource的配置,不然会报错</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span> <span class="hljs-comment">#数据源类型:HikariCP</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span> <span class="hljs-comment">#mysql驱动</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/foodie-shop</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">elasticsearch:</span><br>      <span class="hljs-comment"># 集群</span><br>      <span class="hljs-comment"># cluster-nodes: 192.168.198.100:9300,192.168.198.101:9300,192.168.198.102:9300</span><br>      <span class="hljs-comment"># 单机</span><br>      <span class="hljs-attr">cluster-nodes:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.100</span><span class="hljs-string">:9300</span><br>      <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">es6.4.3</span><br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>可能会报错</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">ERROR SpringApplication Application run failed<br> org.springframework.beans.factory.BeanCreationException: Error creating bean with name <span class="hljs-string">&#x27;elasticsearchClient&#x27;</span> defined in <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">path</span> <span class="hljs-title">resource</span> [<span class="hljs-title">org</span>/<span class="hljs-title">springframework</span>/<span class="hljs-title">boot</span>/<span class="hljs-title">autoconfigure</span>/<span class="hljs-title">data</span>/<span class="hljs-title">elasticsearch</span>/<span class="hljs-title">ElasticsearchAutoConfiguration</span>.<span class="hljs-title">class</span>]: <span class="hljs-title">Bean</span> <span class="hljs-title">instantiation</span> <span class="hljs-title">via</span> <span class="hljs-title">factory</span> <span class="hljs-title">method</span> <span class="hljs-title">failed</span></span>; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.elasticsearch.client.transport.TransportClient]: Factory method <span class="hljs-string">&#x27;elasticsearchClient&#x27;</span> threw exception; nested exception is java.lang.IllegalStateException: availableProcessors is already set to [<span class="hljs-number">8</span>], rejecting [<span class="hljs-number">8</span>]<br></code></pre></td></tr></table></figure>

<blockquote>
<p>解决  Netty issue fix  放到application.class 的同级目录下</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tho;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/11/28/19:23</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> foodstuffMall</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: ESConfig</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: 解决 netty issue fix</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ESConfig</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解决netty引起的issue</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        System.setProperty(<span class="hljs-string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-2、整合后基本使用"><a href="#6-2、整合后基本使用" class="headerlink" title="6.2、整合后基本使用"></a>6.2、整合后基本使用</h2><blockquote>
<p>pojo类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tho.es.pojo;<br><br><span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/11/28/19:32</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> foodstuffMall</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: Student</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: ES测试 实体类 对应 es中的文档</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Document(indexName = &quot;stu&quot;, type = &quot;_doc&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>&#123;<br>    <span class="hljs-meta">@Id</span> <span class="hljs-comment">// 设置之后,数据的id 同 es中的id一起设置为设定值</span><br>    <span class="hljs-keyword">private</span> Long stuId;<br>    <span class="hljs-meta">@Field(store = true)</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-meta">@Field(store = true)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getStuId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> stuId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStuId</span><span class="hljs-params">(Long stuId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.stuId = stuId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(Integer age)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>测试类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> com.tho.Application;<br><span class="hljs-keyword">import</span> com.tho.es.pojo.Student;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.query.IndexQuery;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.query.IndexQueryBuilder;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/11/28/19:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> foodstuffMall</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: ESTest</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: ES 测试</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = Application.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ESTest</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ElasticsearchTemplate esTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createIndexStudent</span><span class="hljs-params">()</span> </span>&#123;<br>        Student student = <span class="hljs-keyword">new</span> Student();<br>        student.setStuId(<span class="hljs-number">1001L</span>);<br>        student.setName(<span class="hljs-string">&quot;tho&quot;</span>);<br>        student.setAge(<span class="hljs-number">18</span>);<br>        IndexQuery query = <span class="hljs-keyword">new</span> IndexQueryBuilder().withObject(student).build();<br>        esTemplate.index(query);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-3、索引增删"><a href="#6-3、索引增删" class="headerlink" title="6.3、索引增删"></a>6.3、索引增删</h2><blockquote>
<ul>
<li><p>不建议使用ElasticsearchTemplate 对索引进行管理(创建索引,更新映射,删除索引)</p>
</li>
<li><p>索引就像是数据库或数据库中的表，平时是不会通过java代码频繁地去创建修改删除数据库中的表的</p>
</li>
<li><p>只会针对数据做CRUD操作</p>
</li>
<li><p>在es中也是同理,尽量使用 ElasticsearchTemplate 对文档数据进行CRUD操作</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>ElasticsearchTemplate缺点</p>
<ol>
<li>属性(FieldType)类型不灵活</li>
<li>主分片于副分片无法设置</li>
</ol>
</blockquote>
<h3 id="1-索引创建"><a href="#1-索引创建" class="headerlink" title="1.索引创建"></a>1.索引创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createIndexStudent</span><span class="hljs-params">()</span> </span>&#123;<br>    Student student = <span class="hljs-keyword">new</span> Student();<br>    student.setStuId(<span class="hljs-number">1001L</span>);<br>    student.setName(<span class="hljs-string">&quot;tho&quot;</span>);<br>    student.setAge(<span class="hljs-number">18</span>);<br>    IndexQuery query = <span class="hljs-keyword">new</span> IndexQueryBuilder().withObject(student).build();<br>    esTemplate.index(query); <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-索引删除"><a href="#2-索引删除" class="headerlink" title="2.索引删除"></a>2.索引删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">@ <span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteIndexStu</span><span class="hljs-params">()</span> </span>&#123;<br>    esTemplate.deleteIndex(Student.class);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-4、文档数据CRUD"><a href="#6-4、文档数据CRUD" class="headerlink" title="6.4、文档数据CRUD"></a>6.4、文档数据CRUD</h2><h3 id="1-新增文档数据"><a href="#1-新增文档数据" class="headerlink" title="1.新增文档数据"></a>1.新增文档数据</h3><blockquote>
<p>同创建索引操作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createIndexStudent</span><span class="hljs-params">()</span> </span>&#123;<br>    Student student = <span class="hljs-keyword">new</span> Student();<br>    student.setStuId(<span class="hljs-number">1001L</span>);<br>    student.setName(<span class="hljs-string">&quot;tho&quot;</span>);<br>    student.setAge(<span class="hljs-number">18</span>);<br>    IndexQuery query = <span class="hljs-keyword">new</span> IndexQueryBuilder().withObject(student).build();<br>    esTemplate.index(query); <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2、更新文档数据"><a href="#2、更新文档数据" class="headerlink" title="2、更新文档数据"></a>2、更新文档数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateStudentDoc</span><span class="hljs-params">()</span> </span>&#123;<br>    Map&lt;String, Object&gt; sourceMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    sourceMap.put(<span class="hljs-string">&quot;sign&quot;</span>, <span class="hljs-string">&quot;xxxxxx&quot;</span>);<br>    sourceMap.put(<span class="hljs-string">&quot;money&quot;</span>, <span class="hljs-number">666.6f</span>);<br>    sourceMap.put(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">3</span>);<br>    IndexRequest request = <span class="hljs-keyword">new</span> IndexRequest();<br>    request.source(sourceMap);<br>    UpdateQuery updateQuery = <span class="hljs-keyword">new</span> UpdateQueryBuilder().withClass(Student.class)<br>            .withId(<span class="hljs-string">&quot;1002&quot;</span>)<br>            .withIndexRequest(request)<br>            .build();<br>    <span class="hljs-comment">// 相当于sql语句</span><br>    <span class="hljs-comment">// update student set sign=&#x27;xxxxxx&#x27;, age=3, money=666.6f where id = &#x27;1002&#x27;</span><br>    esTemplate.update(updateQuery);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-查询文档数据"><a href="#3-查询文档数据" class="headerlink" title="3.查询文档数据"></a>3.查询文档数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getStudentDoc</span><span class="hljs-params">()</span> </span>&#123;<br><br>    GetQuery getQuery = <span class="hljs-keyword">new</span> GetQuery();<br>    getQuery.setId(<span class="hljs-string">&quot;1002&quot;</span>);<br>    Student student = esTemplate.queryForObject(getQuery, Student.class);<br>    System.out.println(student);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-删除文档数据"><a href="#4-删除文档数据" class="headerlink" title="4.删除文档数据"></a>4.删除文档数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteStudentDoc</span><span class="hljs-params">()</span> </span>&#123;<br>    String delete = esTemplate.delete(Student.class, <span class="hljs-string">&quot;1002&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-5、实现分页搜索"><a href="#6-5、实现分页搜索" class="headerlink" title="6.5、实现分页搜索"></a>6.5、实现分页搜索</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Date</span> 2021/11/28 20:18</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">* <span class="hljs-doctag">@Return</span> void</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Description</span>: 分页</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryForPage</span><span class="hljs-params">()</span> </span>&#123;<br><br>    <span class="hljs-comment">// 分页设置</span><br>    Pageable pageable = PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br>    NativeSearchQuery query = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()<br>            .withQuery(QueryBuilders.matchQuery(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;save man&quot;</span>))<br>            .withPageable(pageable)<br>            .build();<br>    AggregatedPage&lt;Student&gt; pagedStudentList = esTemplate.queryForPage(query, Student.class);<br>    <span class="hljs-keyword">int</span> totalPages = pagedStudentList.getTotalPages();<br>    System.out.println(<span class="hljs-string">&quot;检索后总分页数为&quot;</span> + totalPages);<br>    List&lt;Student&gt; studentList = pagedStudentList.getContent();<br>    <span class="hljs-keyword">for</span> (Student student : studentList) &#123;<br>        System.out.println(student);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-6、高亮"><a href="#6-6、高亮" class="headerlink" title="6.6、高亮"></a>6.6、高亮</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Date</span> 2021/11/28 20:22</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Return</span> void</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Description</span>: 高亮显示</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">highLightStudentDoc</span><span class="hljs-params">()</span> </span>&#123;<br><br>        String preTag = <span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span>;<br>        String postTag = <span class="hljs-string">&quot;&lt;/fond&gt;&quot;</span>;<br>        <span class="hljs-comment">// 分页设置</span><br>        Pageable pageable = PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br>        NativeSearchQuery query = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()<br>                .withQuery(QueryBuilders.matchQuery(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;save man&quot;</span>))<br>                .withHighlightFields(<span class="hljs-keyword">new</span> HighlightBuilder.Field(<span class="hljs-string">&quot;description&quot;</span>)<br>                .preTags(preTag)<br>                .postTags(postTag))<br>                .withPageable(pageable)<br>                .build();<br>        AggregatedPage&lt;Student&gt; pagedStudentList = esTemplate.queryForPage(query, Student.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;<br>            <br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse response, Class&lt;T&gt; clazz, Pageable pageable)</span> </span>&#123;<br>                <span class="hljs-comment">// 需要加入自己的映射 直接获取的数据不包括高亮的内容</span><br>                SearchHits hits = response.getHits();<br>                List&lt;Student&gt; studentListHighLight = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>                <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>                    HighlightField highLightField = hit.getHighlightFields().get(<span class="hljs-string">&quot;description&quot;</span>);<br>                    String description  = highLightField.getFragments()[<span class="hljs-number">0</span>].toString();<br><br>                    Object stuId = hit.getSourceAsMap().get(<span class="hljs-string">&quot;id&quot;</span>);<br>                    String name =(String) hit.getSourceAsMap().get(<span class="hljs-string">&quot;name&quot;</span>);<br>                    Integer age =(Integer) hit.getSourceAsMap().get(<span class="hljs-string">&quot;age&quot;</span>);<br>                    String sign =(String) hit.getSourceAsMap().get(<span class="hljs-string">&quot;sign&quot;</span>);<br>                    Object money = hit.getSourceAsMap().get(<span class="hljs-string">&quot;money&quot;</span>);<br><br>                    Student highLightStudent = <span class="hljs-keyword">new</span> Student();<br>                    highLightStudent.setDescription(description);<br>                    highLightStudent.setAge(age);<br>                    highLightStudent.setSign(sign);<br>                    highLightStudent.setMoney(Float.valueOf(money.toString()));<br>                    highLightStudent.setStuId(Long.valueOf(stuId.toString()));<br>                    highLightStudent.setName(name);<br><br>                    studentListHighLight.add(highLightStudent);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (studentListHighLight.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl&lt;&gt;( (List&lt;T&gt;) studentListHighLight);<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">int</span> totalPages = pagedStudentList.getTotalPages();<br>        System.out.println(<span class="hljs-string">&quot;检索后总分页数为&quot;</span> + totalPages);<br>        List&lt;Student&gt; studentList = pagedStudentList.getContent();<br>        <span class="hljs-keyword">for</span> (Student student : studentList) &#123;<br>            System.out.println(student);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-7、排序"><a href="#6-7、排序" class="headerlink" title="6.7、排序"></a>6.7、排序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Date</span> 2021/11/28 20:44</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">* <span class="hljs-doctag">@Return</span> void</span><br><span class="hljs-comment">* <span class="hljs-doctag">@Description</span>: 排序</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sortStudentDoc</span><span class="hljs-params">()</span> </span>&#123;<br><br>    String preTag = <span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span>;<br>    String postTag = <span class="hljs-string">&quot;&lt;/fond&gt;&quot;</span>;<br>    <span class="hljs-comment">// 分页设置</span><br>    Pageable pageable = PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br><br>    <span class="hljs-comment">// 排序</span><br>    SortBuilder sortBuilder = <span class="hljs-keyword">new</span> FieldSortBuilder(<span class="hljs-string">&quot;money&quot;</span>)<br>            .order(SortOrder.ASC);<br><br>    NativeSearchQuery query = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()<br>            .withQuery(QueryBuilders.matchQuery(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;save man&quot;</span>))<br>            .withHighlightFields(<span class="hljs-keyword">new</span> HighlightBuilder.Field(<span class="hljs-string">&quot;description&quot;</span>)<br>                    .preTags(preTag)<br>                    .postTags(postTag))<br>            .withPageable(pageable)<br>            .withSort(sortBuilder) <span class="hljs-comment">//排序</span><br>            .build();<br>    AggregatedPage&lt;Student&gt; pagedStudentList = esTemplate.queryForPage(query, Student.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse response, Class&lt;T&gt; clazz, Pageable pageable)</span> </span>&#123;<br>            <span class="hljs-comment">// 需要加入自己的映射 直接获取的数据不包括高亮的内容</span><br>            SearchHits hits = response.getHits();<br>            List&lt;Student&gt; studentListHighLight = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>                HighlightField highLightField = hit.getHighlightFields().get(<span class="hljs-string">&quot;description&quot;</span>);<br>                String description  = highLightField.getFragments()[<span class="hljs-number">0</span>].toString();<br><br>                Object stuId = hit.getSourceAsMap().get(<span class="hljs-string">&quot;id&quot;</span>);<br>                String name =(String) hit.getSourceAsMap().get(<span class="hljs-string">&quot;name&quot;</span>);<br>                Integer age =(Integer) hit.getSourceAsMap().get(<span class="hljs-string">&quot;age&quot;</span>);<br>                String sign =(String) hit.getSourceAsMap().get(<span class="hljs-string">&quot;sign&quot;</span>);<br>                Object money = hit.getSourceAsMap().get(<span class="hljs-string">&quot;money&quot;</span>);<br><br>              	<span class="hljs-comment">// 要加判断 因为字段名称问题,可能从es中搜索不到记录</span><br>              	<span class="hljs-comment">// 有的字段可能会是空指针</span><br>             		<span class="hljs-comment">// Long.valueOf(stuId.toString() 会报空指针异常</span><br>              <br>                Student highLightStudent = <span class="hljs-keyword">new</span> Student();<br>                highLightStudent.setDescription(description);<br>                highLightStudent.setAge(age);<br>                highLightStudent.setSign(sign);<br>                highLightStudent.setMoney(Float.valueOf(money.toString()));<br>                highLightStudent.setStuId(Long.valueOf(stuId.toString()));<br>                highLightStudent.setName(name);<br><br>                studentListHighLight.add(highLightStudent);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (studentListHighLight.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl&lt;&gt;( (List&lt;T&gt;) studentListHighLight);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">int</span> totalPages = pagedStudentList.getTotalPages();<br>    System.out.println(<span class="hljs-string">&quot;检索后总分页数为&quot;</span> + totalPages);<br>    List&lt;Student&gt; studentList = pagedStudentList.getContent();<br>    <span class="hljs-keyword">for</span> (Student student : studentList) &#123;<br>        System.out.println(student);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="七、Logstash"><a href="#七、Logstash" class="headerlink" title="七、Logstash"></a>七、Logstash</h1><blockquote>
<p>mysql控制远程连接</p>
<p>mysql数据库中的user表</p>
<p>user -&gt; host 对应关系</p>
<p>host为 % 都可以连接</p>
<p>host 有localhost 只有localhost可以连接</p>
</blockquote>
<h2 id="7-1、数据同步"><a href="#7-1、数据同步" class="headerlink" title="7.1、数据同步"></a>7.1、数据同步</h2><blockquote>
<p>Logstash是elastic技术栈中的一个技术。它是一个数据采集引擎，可以从数据库采集数据到es中。我们可以通过设置自增id主键或者时间来控制数据的自动同步 时间就是用于给logstash进行识别的</p>
<ul>
<li><p>id：假设现在有1000条数据，Logstatsh识别后会进行一次同步，同步完会记录这个id为1000，以后数据库新增数据，那么id会一直累加 h会有定时任务，发现有id大于1000了，则增量加入到es中 </p>
</li>
<li><p>时间：同理，一开始同步1000条数据，每条数据都有一个字段，为time，初次同步完毕后，记录这个time，下次同步的时候进行时间比 超过这个时间的，那么就可以做同步，这里可以同步新增数据，或者修改元数据，因为同一条数据的时间更改会被识别，而id则不会。</p>
</li>
<li><p>预先创建索引</p>
</li>
</ul>
</blockquote>
<h2 id="7-2、环境配置"><a href="#7-2、环境配置" class="headerlink" title="7.2、环境配置"></a>7.2、环境配置</h2><blockquote>
<p>Logstash 要与 es 版本一致</p>
<ul>
<li><p>需要本机配置jdk 环境</p>
</li>
<li><p>插件 ： logstash-input-jdbc </p>
<p>  ​    本插件用于同步，es6.x起自带，这个是集成在了 logstash中的。所以直接配置同步数据库的配置文件即可</p>
</li>
<li><p>需要logstash.tar.gz 包</p>
</li>
<li><p>需要mysql的驱动</p>
</li>
</ul>
</blockquote>
<ol>
<li><p>解压logstash 放到 <code>/user/local/logstash</code> 下</p>
</li>
<li><p>在 <code>/usr/local/logstash/logstash-6.4.3</code> 下创建 <code>sync</code> 文件夹</p>
</li>
<li><p>在 sync 文件夹下创建 logstash配置文件 <code>logstash-db-sync.conf</code>,  查询mysql数据库的sql脚本 <code>food-items.sql</code>, mysql驱动 <code>mysql-connector-java-5.1.41.jar</code></p>
<blockquote>
<p>logstash-db-sync.conf</p>
</blockquote>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java">input &#123;<br>	jdbc &#123;<br>		# 设置mysql/MariaDB 数据库Url 以及数据库名称<br>		jdbc_connection_string =&gt; <span class="hljs-string">&quot;jdbc:mysql://192.168.31.207:3306/foodie-shop&quot;</span><br>		# 用户名和密码<br>		jdbc_user =&gt; <span class="hljs-string">&quot;root&quot;</span><br>		jdbc_password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>		# 数据库驱动所在位置,可以是绝对路径或者相对路径<br>		jdbc_driver_library =&gt; <span class="hljs-string">&quot;/usr/local/logstash/logstash-6.4.3/sync/mysql-connector-java-5.1.41.jar&quot;</span><br>		# 驱动类名<br>		jdbc_driver_class =&gt; <span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span><br>		# 开启分页<br>		jdbc_paging_enabled =&gt; <span class="hljs-string">&quot;true&quot;</span><br>		# 分页每页数量,可以自定义<br>		jdbc_page_size =&gt; <span class="hljs-string">&quot;10000&quot;</span><br>		# 执行sql文件路径<br>		statement_filepath =&gt; <span class="hljs-string">&quot;/usr/local/logstash/logstash-6.4.3/sync/food-items.sql&quot;</span><br>		# 设置定时任务间隔  含义: 分，时，天，月，年， 全部为* 默认含义每分钟跑一次<br>		schedule =&gt; <span class="hljs-string">&quot;* * * * *&quot;</span><br>		# 索引类型<br>		type =&gt; <span class="hljs-string">&quot;_doc&quot;</span><br>		# 是否开启记录上次追踪的结果，也就是上次更新的时间，这个会记录到 last_run_metadata_path 的文件<br>		use_column_value =&gt; <span class="hljs-keyword">true</span><br>		# 记录上一次追踪的结果值<br>		last_run_metadata_path =&gt;  <span class="hljs-string">&quot;/usr/local/logstash/logstash-6.4.3/sync/track_time&quot;</span><br>		# 如果 use_column_value 为 <span class="hljs-keyword">true</span> ， 配置本参数 ， 追踪的column名 ， 可以是自增id 或者时间<br>		tracking_column =&gt; <span class="hljs-string">&quot;update_time&quot;</span><br>		# tracking_column 对应字段的类型<br>		tracking_column_type =&gt; <span class="hljs-string">&quot;timestamp&quot;</span><br>		# 是否清除 last_run_metadata_path 的记录, <span class="hljs-keyword">true</span>则每次都从头开始查询所有记录<br>		clean_run =&gt; <span class="hljs-keyword">false</span><br>		# 数据库字段名称大写转小写<br>		lowercase_column_names =&gt; <span class="hljs-keyword">false</span><br>	&#125;<br>&#125;<br>output &#123;<br>	elasticsearch &#123;<br>		# es地址<br>		hosts =&gt; [<span class="hljs-string">&quot;192.168.198.100:9200&quot;</span>]<br>		# 同步的索引名<br>		index =&gt; <span class="hljs-string">&quot;food-items&quot;</span><br>		# 设置 _docID 和 数据相同<br>		document_id =&gt; <span class="hljs-string">&quot;%&#123;itemId&#125;&quot;</span> <br>	&#125;<br>	<br>	# 日志输出<br>	stdout &#123;<br>		codec =&gt; json_lines<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>food-items.sql</p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>            i.id <span class="hljs-keyword">as</span> itemId,<br>            i.item_name <span class="hljs-keyword">as</span> itemName,<br>            i.sell_counts <span class="hljs-keyword">as</span> sellCounts,<br>            ii.url <span class="hljs-keyword">as</span> imgUrl,<br>            tempSpec.priceDiscount <span class="hljs-keyword">as</span> price,<br>						i.updated_time <span class="hljs-keyword">as</span> updated_time<br>        <span class="hljs-keyword">FROM</span><br>            items i<br>        <span class="hljs-keyword">left</span> <span class="hljs-keyword">JOIN</span><br>            items_img ii<br>        <span class="hljs-keyword">on</span><br>            i.id <span class="hljs-operator">=</span> ii.item_id<br>        <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span><br>            (<br>                <span class="hljs-keyword">SELECT</span><br>                    item_id,<span class="hljs-built_in">MIN</span>(price_discount) <span class="hljs-keyword">as</span> priceDiscount<br>                <span class="hljs-keyword">FROM</span><br>                    items_spec<br>                <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>                    item_id<br>            )tempSpec<br>        <span class="hljs-keyword">on</span><br>            i.id <span class="hljs-operator">=</span> tempSpec.item_id<br><br>        <span class="hljs-keyword">WHERE</span><br>            ii.is_main <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>						<span class="hljs-keyword">and</span> <br>						i.updated_time <span class="hljs-operator">&gt;=</span> :sql_last_value<br></code></pre></td></tr></table></figure></li>
<li><p>进入 bin 目录 执行命令 <code>./logstash -f /usr/local/logstash-6.4.3/sync/logstash-db-sync.conf</code></p>
</li>
<li><p>mysql 主键字段  要与  elasticSearch 的 _id 相一致</p>
</li>
<li><p>logstash 的 timestamp 要与 mysql数据库中的 <code>updated_time</code> 相匹配</p>
</li>
<li><p>==远程连接 mysql 失败 <code>mysql.user</code>  表中 root 用户 对应的的 host 地址是否包含要读取mysql数据库的ip== </p>
</li>
</ol>
<h2 id="7-3、logstash数据更新"><a href="#7-3、logstash数据更新" class="headerlink" title="7.3、logstash数据更新"></a>7.3、logstash数据更新</h2><blockquote>
<p>mysql数据库中的数据有变化,可以通过 改变 update_time 字段来让logstash自动更新ES中的数据,也可以通过改变 update_time 字段来进行逻辑删除</p>
</blockquote>
<h2 id="7-4、logstash中文分词模板"><a href="#7-4、logstash中文分词模板" class="headerlink" title="7.4、logstash中文分词模板"></a>7.4、logstash中文分词模板</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">GET http:<span class="hljs-comment">//192.168.198.100:9200/_template/logstash、</span><br><span class="hljs-comment">// 将返回的内容进行修改,修改后如下所示</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>建立一个模板文件  <code>logstash-ik.json</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs JSON">&#123;<br>    <br>        <span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">&quot;version&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;index_patterns&quot;</span>: [<br>            <span class="hljs-string">&quot;*&quot;</span><br>        ],<br>        <span class="hljs-attr">&quot;settings&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;refresh_interval&quot;</span>: <span class="hljs-string">&quot;5s&quot;</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;_default_&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;dynamic_templates&quot;</span>: [<br>                    &#123;<br>                        <span class="hljs-attr">&quot;message_field&quot;</span>: &#123;<br>                            <span class="hljs-attr">&quot;path_match&quot;</span>: <span class="hljs-string">&quot;message&quot;</span>,<br>                            <span class="hljs-attr">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                            <span class="hljs-attr">&quot;mapping&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                                <span class="hljs-attr">&quot;norms&quot;</span>: <span class="hljs-literal">false</span><br>                            &#125;<br>                        &#125;<br>                    &#125;,<br>                    &#123;<br>                        <span class="hljs-attr">&quot;string_fields&quot;</span>: &#123;<br>                            <span class="hljs-attr">&quot;match&quot;</span>: <span class="hljs-string">&quot;*&quot;</span>,<br>                            <span class="hljs-attr">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                            <span class="hljs-attr">&quot;mapping&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                                <span class="hljs-attr">&quot;norms&quot;</span>: <span class="hljs-literal">false</span>,<br>                              <span class="hljs-comment">// 这里修改</span><br>                              <span class="hljs-comment">// String 会匹配到 text 进行 ik_max_word 分词</span><br>                              <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>                                <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>                                    <span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br>                                        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                                        <span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                                    &#125;<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                ],<br>                <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;@timestamp&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>                    &#125;,<br>                    <span class="hljs-attr">&quot;@version&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>                    &#125;,<br>                    <span class="hljs-attr">&quot;geoip&quot;</span>: &#123;<br>                        <span class="hljs-attr">&quot;dynamic&quot;</span>: <span class="hljs-literal">true</span>,<br>                        <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>                            <span class="hljs-attr">&quot;ip&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;ip&quot;</span><br>                            &#125;,<br>                            <span class="hljs-attr">&quot;location&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;geo_point&quot;</span><br>                            &#125;,<br>                            <span class="hljs-attr">&quot;latitude&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;half_float&quot;</span><br>                            &#125;,<br>                            <span class="hljs-attr">&quot;longitude&quot;</span>: &#123;<br>                                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;half_float&quot;</span><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">&quot;aliases&quot;</span>: &#123;&#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>将 json 文件 放入 <code>/usr/local/logstash/logstash-6.4.3/sync</code> 目录下</p>
</li>
<li><p>修改  <code>logstash-db-sync.conf</code> 配置文件</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">output &#123;<br>	elasticsearch &#123;<br>		# es地址<br>		hosts =&gt; [<span class="hljs-string">&quot;192.168.198.100:9200&quot;</span>]<br>		# 同步的索引名<br>		index =&gt; <span class="hljs-string">&quot;food-items&quot;</span><br>		# 设置 _docID 和 数据相同<br>		document_id =&gt; <span class="hljs-string">&quot;%&#123;itemId&#125;&quot;</span> <br>		<br>		# 定义模板名称<br>		template_name =&gt; <span class="hljs-string">&quot;myik&quot;</span><br>		# 模板所在位置<br>		template =&gt; <span class="hljs-string">&quot;/usr/local/logstash/logstash-6.4.3/sync/logstash-ik.json&quot;</span><br>		# 重写模板<br>		template_overwrite =&gt; <span class="hljs-keyword">true</span><br>		# 默认为<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>关闭logstash自动管理模板功能，如果自定义模板,则设置为<span class="hljs-keyword">false</span><br>		manage_template =&gt; <span class="hljs-keyword">false</span><br>	&#125;<br>	<br>	# 日志输出<br>	stdout &#123;<br>		codec =&gt; json_lines<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>之后可以进行logstash 与 mysql 的同步</p>
<p> <code>./logstash -f /usr/local/logstash/logstash-6.4.3/sync/logstash-db-sync.conf</code></p>
</li>
</ol>
<h2 id="7-5、logstash-中文分词器配置失效"><a href="#7-5、logstash-中文分词器配置失效" class="headerlink" title="7.5、logstash-中文分词器配置失效"></a>7.5、logstash-中文分词器配置失效</h2><blockquote>
<p>分词配置不成功，analyzer不显示</p>
</blockquote>
<p>1.先将logstash的配置文件 <code>logstash-db-sync.conf</code> 中的 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"># 默认为<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>关闭logstash自动管理模板功能，如果自定义模板,则设置为<span class="hljs-literal">false</span><br>		manage_template =&gt; <span class="hljs-literal">true</span> <span class="hljs-comment">// 设置为true</span><br></code></pre></td></tr></table></figure>

<p>2.删除原先索引，新建相同名字索引，启动logstash同步数据的脚本</p>
<p>3.使用postman查看模板是否配置成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">GET http:<span class="hljs-comment">//192.168.198.100:9200/_template/myik</span><br><span class="hljs-comment">// 有返回值,说明配置模板成功</span><br></code></pre></td></tr></table></figure>

<p>4.再将logstash配置文件 中的 manage_template 设置为false</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"># 默认为<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>关闭logstash自动管理模板功能，如果自定义模板,则设置为<span class="hljs-literal">false</span><br>		manage_template =&gt; <span class="hljs-literal">false</span> <span class="hljs-comment">// 设置为false</span><br></code></pre></td></tr></table></figure>

<p>5.再次运行logstash 同步数据脚本 之后es索引应该能显示analyzer分词设置</p>
<h1 id="八、ES整合项目"><a href="#八、ES整合项目" class="headerlink" title="八、ES整合项目"></a>八、ES整合项目</h1><h2 id="8-1、初始化web环境"><a href="#8-1、初始化web环境" class="headerlink" title="8.1、初始化web环境"></a>8.1、初始化web环境</h2><blockquote>
<p>配置tomcat端口号</p>
<p>写一个简单的用于测试的controller</p>
<p>es模块依赖于 common 模块 pom.xml 中引入其依赖 </p>
<p>配置一个maven脚本 跳过test    <code>install -Dmaven.test.skip=true</code></p>
<ul>
<li>鼠标右键install -&gt; 选择 create * -&gt; command line 填入 <code>install -Dmaven.test.skip=true</code></li>
<li>之后会在下面自动生成Run Configurations , 其中会有刚才写的 maven脚本</li>
</ul>
<p>导入log4j日志依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--log4j 日志依赖--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.11.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>拷贝log4j.properties 配置文件到search 模块下 修改配置文件中的路径参数</p>
</blockquote>
<h2 id="8-2、高亮"><a href="#8-2、高亮" class="headerlink" title="8.2、高亮"></a>8.2、高亮</h2><p>使用<em> 标签 可以在前端自定义高亮样式</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/ElasticSearch/">ElasticSearch</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/ElasticSearch/">ElasticSearch</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章可随意转载
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/11/20/Redis/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Redis</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/11/01/mysql_Sql_Learn/">
                        <span class="hidden-mobile">MySQL</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
