

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/mario.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="RabbitMQ基本使用">
  <meta name="author" content="tho">
  <meta name="keywords" content="">
  <meta name="description" content="RabbitMQ基本使用">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="http://example.com/2021/12/05/RabbitMQ/index.html">
<meta property="og:site_name" content="Tho668&#39;s Blogs">
<meta property="og:description" content="RabbitMQ基本使用">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-12-05T10:35:56.000Z">
<meta property="article:modified_time" content="2022-03-04T14:07:43.215Z">
<meta property="article:author" content="tho">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary_large_image">
  
  <title>RabbitMQ - Tho668&#39;s Blogs</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tho668</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/galaxy.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="RabbitMQ">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-12-05 18:35" pubdate>
        December 5, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      20k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      62 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">RabbitMQ</h1>
            
            <div class="markdown-body">
              <p>RabbitMQ基本使用</p>
<span id="more"></span>

<ul>
<li><p>分布式消息队列(MQ)认知与提升</p>
</li>
<li><p>RabbitMQ实战</p>
</li>
<li><p>RabbitMQ可靠性投递基础组件封装</p>
</li>
</ul>
<h1 id="一、MQ基础"><a href="#一、MQ基础" class="headerlink" title="一、MQ基础"></a>一、MQ基础</h1><h2 id="1-1、MQ应用场景"><a href="#1-1、MQ应用场景" class="headerlink" title="1.1、MQ应用场景"></a>1.1、MQ应用场景</h2><blockquote>
<p>JMS（Java Message Service）规 ava消息服务，它定义了Java中访问消息中间件的接口的规范。在这里注意哦，JMS只是接口，并没有给予实现，实现JMS接口的消息中间件称为 “JMS Provide 的开源 MOM （Message Oriented Middleware，也就是消息中间件）系统包括Apache的ActiveMQ、RocketMQ、Kafka，以及RabbitMQ，可以说他们都 “基本遵 考” JMS规范，都有自己的特点和优势。 </p>
<ul>
<li>专业术语 <ul>
<li>JMS（Java Message Service）：实现JMS 接口的消息中间件； </li>
<li>Provider（MessageProvider）：消息的生产者； </li>
<li>Consumer（MessageConsumer）：消息的消费者； </li>
<li>PTP（Point to Point）：即点对点的消息模型，这也是非常经典的模型； </li>
<li>Pub / Sub（Publish/Subscribe）：，即发布/订阅的消息模型； </li>
<li>Queue：队列目标，也就是我们常说的消息队列，一般都是会真正的进行物理存储；</li>
<li> Topic：主题目标； </li>
<li>ConnectionFactory：连接工厂，JMS 用它创建连接；</li>
<li> Connection：JMS 客户端到JMS Provider 的连接；</li>
<li> Destination：消息的目的地； </li>
<li>Session：会话，一个发送或接收消息的线程（这里Session可以类比Mybatis的Session</li>
</ul>
</li>
<li>JMS消息格式定义：<ul>
<li> StreamMessage 原始值的数据流 </li>
<li>MapMessage 一套名称/值对 </li>
<li>TextMessage 一个字符串对象</li>
<li> BytesMessage 一个未解释字节的数据流 </li>
<li>ObjectMessage 一个序列化的Java对象</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>服务解耦</li>
<li>销峰填谷</li>
<li>异步化缓冲</li>
</ul>
<blockquote>
<p>思考点</p>
<ul>
<li>生产端可靠性投递</li>
<li>消费端幂等性</li>
<li>高可用</li>
<li>低延迟</li>
<li>可靠性</li>
<li>堆积能力</li>
<li>可扩展性</li>
</ul>
</blockquote>
<h2 id="1-2、主流MQ"><a href="#1-2、主流MQ" class="headerlink" title="1.2、主流MQ"></a>1.2、主流MQ</h2><ul>
<li>ActiveMQ 阿帕奇   (性能较差)</li>
<li>RabbitMQ (重点)   (扩展性较差)</li>
<li>RocketMQ (阿里 -&gt; 阿帕奇)</li>
<li>Kafka (高吞吐量,数据转储)</li>
</ul>
<blockquote>
<p>如何进行技术选型</p>
<ul>
<li>各个MQ的性能,优缺点，相应的业务场景</li>
<li>集群架构模式，分布式，可扩展性，高可用性，可维护性</li>
<li>综合成本问题，集群规模，人员成本</li>
<li>未来的方向，规划，思考</li>
</ul>
</blockquote>
<h2 id="1-3、RabbitMQ集群架构模型与原理"><a href="#1-3、RabbitMQ集群架构模型与原理" class="headerlink" title="1.3、RabbitMQ集群架构模型与原理"></a>1.3、RabbitMQ集群架构模型与原理</h2><p>1.主备模式(master -&gt; slave)</p>
<p>2.远程模式(配置复杂)</p>
<p>3.镜像模式(使用最为广泛)</p>
<p>4.多活模型(类似远程模式)</p>
<h3 id="1、主备模式"><a href="#1、主备模式" class="headerlink" title="1、主备模式"></a>1、主备模式</h3><ul>
<li>warren(兔子窝),主备方案 ,主节点挂了,备份节点启用</li>
</ul>
<h3 id="2、远程模式"><a href="#2、远程模式" class="headerlink" title="2、远程模式"></a>2、远程模式</h3><ul>
<li>远距离通信复制，实现双活的一种模式，让两个跨地域的MQ构成集群</li>
<li>配置复杂</li>
</ul>
<h3 id="3、镜像模式"><a href="#3、镜像模式" class="headerlink" title="3、镜像模式"></a>3、镜像模式</h3><ul>
<li>保证100%数据不丢失</li>
<li>在实际工作中用的最多，并且实现集群非常简单，一般互联网大厂都会构建这种集群模式</li>
</ul>
<blockquote>
<p>高可用  数据同步  高可靠(奇数个节点)</p>
<p>无法横向扩展</p>
<p>多个服务器同步相同数据</p>
</blockquote>
<h3 id="4、多活模式"><a href="#4、多活模式" class="headerlink" title="4、多活模式"></a>4、多活模式</h3><ul>
<li>依赖RabbitMQ的 federation插件</li>
<li>RabbitMQ部署架构采用双中心(多中心),那么在两套(或者多套)数据中心部署一套RabbitMQ集群，各中心的RabbitMQ服务除了需要为业务提供正常的消息服务外，中心之间还需要实现部分队列消息共享</li>
</ul>
<h1 id="二、RabbitMQ"><a href="#二、RabbitMQ" class="headerlink" title="二、RabbitMQ"></a>二、RabbitMQ</h1><h2 id="2-1、基础"><a href="#2-1、基础" class="headerlink" title="2.1、基础"></a>2.1、基础</h2><blockquote>
<p>RabbitMQ是一个开源的消息代理和队列服务器，用来通过普通协议在完全不同的应用之间共享数据，RabbitMQ是使用Erlang语言来编写的，并且RabbitMQ是基 议的。各个互联网大厂都在使用RabbitMQ作为消息中间件，为什么呢，下面我们来一起看看，“她” 都有哪些优点！ </p>
<ul>
<li>采用Erlang语言作为底层实现：Erlang有着和原生Socket一样的延迟 </li>
<li>开源、性能优秀，稳定性保障 </li>
<li>提供可靠性消息投递模式（confirm）、返回模式（ return ） </li>
<li>与SpringAMQP完美的整合、API丰富 </li>
<li>集群模式丰富，表达式配置，HA模式，镜像队列模型</li>
<li> 保证数据不丢失的前提做到高可靠性、可用性</li>
</ul>
</blockquote>
<ul>
<li>AMQP核心概念</li>
<li>RabbitMQ安装与入门</li>
<li>RabbitMQ核心API</li>
<li>RabbitMQ高级特性</li>
<li>RabbitMQ集群架构实操（镜像集群）</li>
<li>SpringBoot整合</li>
<li>MQ基础组件封装和实战</li>
</ul>
<h2 id="2-2、RabbitMQ环境搭建"><a href="#2-2、RabbitMQ环境搭建" class="headerlink" title="2.2、RabbitMQ环境搭建"></a>2.2、RabbitMQ环境搭建</h2><h3 id="1-首先安装erlang环境"><a href="#1-首先安装erlang环境" class="headerlink" title="1.首先安装erlang环境"></a>1.首先安装erlang环境</h3><p>因为RabbitMQ需要erlang环境的支持，所以必须安装erlang</p>
<p>要安装的是 erlang-22.3.3-1.el7.x86_64.rpm 先执行以下命令来安装其对应的yum repo</p>
<p><code>curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash</code></p>
<p>执行以下命令来正式安装 erlang 环境</p>
<p><code>yum install erlang-22.3.3-1.el7.x86_64</code></p>
<p>(如果有提示 重新执行该事务) 执行命令</p>
<p><code>yum load-transaction /tmp/yum_save_tx.2020-05-14.22-21.n0cwzm.yumtx</code></p>
<p>测试erlang是否安装成功</p>
<p><code>erl</code></p>
<p>出现</p>
<blockquote>
<p>[root@centos_7_100 ~]# erl<br>Erlang/OTP 22 [erts-10.7.1] [source] [64-bit] [smp:1:1] [ds:1:1:10] [async-threads:1] [hipe]</p>
<p>Eshell V10.7.1  (abort with ^G)</p>
<p>说明安装成功</p>
</blockquote>
<h3 id="2、安装RabbitMQ"><a href="#2、安装RabbitMQ" class="headerlink" title="2、安装RabbitMQ"></a>2、安装RabbitMQ</h3><p>首先安装其对应的yum repo</p>
<p><code>curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | sudo bash</code></p>
<p>执行命令正式安装RabbitMQ</p>
<p><code>yum install rabbitmq-server-3.8.3-1.el7.noarch</code></p>
<h3 id="3、设置RabbitMQ开机启动"><a href="#3、设置RabbitMQ开机启动" class="headerlink" title="3、设置RabbitMQ开机启动"></a>3、设置RabbitMQ开机启动</h3><p>(关闭防火墙或者打开 15672端口)</p>
<p><code>chkconfig rabbitmq-server on</code></p>
<p>启动RabbitMQ服务</p>
<p><code>systemctl start rabbitmq-server.service</code></p>
<p>开启WEB可视化管理插件</p>
<p><code>rabbitmq-plugins enable rabbitmq_management</code></p>
<p>访问可视化管理界⾯</p>
<p><a target="_blank" rel="noopener" href="http://192.168.198.100:15672/">http://192.168.198.100:15672</a></p>
<p>能看到网页登录入口</p>
<p>我们可以在后台添加一个用户/密码对</p>
<p><code>rabbitmqctl add_user tho 123456 </code></p>
<p><code>rabbitmqctl set_user_tags tho administrator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">[root<span class="hljs-meta">@centos_7_100</span> ~]# rabbitmqctl add_user tho <span class="hljs-number">123456</span><br>Adding user <span class="hljs-string">&quot;tho&quot;</span> ...<br>[root<span class="hljs-meta">@centos_7_100</span> ~]# <br>[root<span class="hljs-meta">@centos_7_100</span> ~]# rabbitmqctl set_user_tags tho administrator<br>Setting tags <span class="hljs-keyword">for</span> user <span class="hljs-string">&quot;tho&quot;</span> to [administrator] ...<br>[root<span class="hljs-meta">@centos_7_100</span> <span class="hljs-number">8</span>~]# <br></code></pre></td></tr></table></figure>

<p>之后在网页登录即可</p>
<h2 id="2-3、RabbitMQ高性能"><a href="#2-3、RabbitMQ高性能" class="headerlink" title="2.3、RabbitMQ高性能"></a>2.3、RabbitMQ高性能</h2><ul>
<li>Erlang语言用于交换机领域的架构模式</li>
<li>Erlang有着和原生Socket一样的延迟</li>
</ul>
<blockquote>
<p>AMQP高级消息队列协议</p>
<ul>
<li>AMQP协议模型</li>
</ul>
</blockquote>
<p>AMQP核心概念</p>
<blockquote>
<ul>
<li>Server：Broker，接收客户端连接，实现AMQP实体服务</li>
<li>Connection：连接，应用程序与Broker的网络连接</li>
<li>Channel：网络信道，所以的操作几乎都在Channel中进行，客户端可以建立多个Channel，每个Channel代表一个会话任务</li>
<li>Message：消息，服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级，延迟等高级特性，Body则是消息体内容</li>
<li>Virtual Host：虚拟地址，进行逻辑隔离，最上层的消息路由，一个Virtual host里可以有多干个Exchange和Queue，同一个Virtual Host 不能有相同名称的Exchange和Queue</li>
<li>Exchange：交换机，接收消息，根据路由键转发消息到绑定的队列</li>
<li>Binding：Exchange和Queue之间的虚拟连接，binding中包括 routing key</li>
<li>Routing key ： 一个路由规则，虚拟机 可用它来确定如何路由一个特定消息</li>
<li>Queue：也称为Message Queue：消息队列，保存消息并把它们转发给消费者</li>
</ul>
</blockquote>
<blockquote>
<p>RabbitMQ整体架构</p>
<p>producer -&gt; exchange -&gt; queue -&gt; consumer</p>
</blockquote>
<h2 id="2-4、如何保证100-投递成功"><a href="#2-4、如何保证100-投递成功" class="headerlink" title="2.4、如何保证100%投递成功"></a>2.4、如何保证100%投递成功</h2><blockquote>
<p>生产端可靠性投递</p>
<ul>
<li>保证消息的成功发出</li>
<li>保证MQ节点成功接收</li>
<li>发送端接收到MQ节点(Broker)确认应答</li>
<li>完善的消息进行补偿机制</li>
</ul>
</blockquote>
<blockquote>
<p>解决方案</p>
<ul>
<li>消息落库，对消息状态进行打标(高并发场景下不太合适)</li>
<li>消息延迟投递，做二次确认，回调检查(较为常用，减少数据库操作)</li>
</ul>
</blockquote>
<h2 id="2-5、幂等性"><a href="#2-5、幂等性" class="headerlink" title="2.5、幂等性"></a>2.5、幂等性</h2><blockquote>
<ul>
<li>借鉴数据库的乐观锁机制、</li>
<li>执行一条更新库存的sql语句</li>
<li>update t_reps set count = count - 1, version = version + 1 where version = 1</li>
</ul>
</blockquote>
<blockquote>
<p>海量订单产生的业务高峰期，如何避免消息的重复消费问题</p>
<ul>
<li>消费端实现幂等性，就意味着，我们的消息永远不会消费多次，即使我们收到了多条一样的消息</li>
</ul>
</blockquote>
<blockquote>
<p>消费端-幂等性保障</p>
<ul>
<li>唯一ID + 指纹码 机制，利用数据库主键去重</li>
<li>利用Redis的原子性去实现</li>
</ul>
</blockquote>
<h3 id="1-唯一id-指纹码-机制"><a href="#1-唯一id-指纹码-机制" class="headerlink" title="1.唯一id + 指纹码 机制"></a>1.唯一id + 指纹码 机制</h3><ul>
<li>唯一ID + 指纹码机制，利用数据库主键去重</li>
<li>Select count(1) from t_order where id = 唯一id + 枝纹码</li>
<li>好处 ： 实现简单</li>
<li>坏处： 高并发下有数据库写入的性能瓶颈</li>
<li>解决方案：跟进ID进行分库分表进行算法路由</li>
</ul>
<h3 id="2-利用Redis原子特性实现"><a href="#2-利用Redis原子特性实现" class="headerlink" title="2.利用Redis原子特性实现"></a>2.利用Redis原子特性实现</h3><ul>
<li>利用Redis进行幂等性操作</li>
</ul>
<blockquote>
<p>需要考虑的问题</p>
<ul>
<li>是否要进行数据库落库，如果落库的话，数据库和缓存如何做到原子性(一致性)</li>
<li>如果不进行落库，都存储到缓存中，如何设置定时同步策略</li>
</ul>
</blockquote>
<h2 id="2-6、整合SpringBoot"><a href="#2-6、整合SpringBoot" class="headerlink" title="2.6、整合SpringBoot"></a>2.6、整合SpringBoot</h2><p>1.@RabbitListener注解</p>
<blockquote>
<p>消费端监听 @RabbitMQListener</p>
<p>@QueueBinding @Queue @Exchange</p>
</blockquote>
<h3 id="1-生产者"><a href="#1-生产者" class="headerlink" title="1.生产者"></a>1.生产者</h3><h4 id="相关依赖配置"><a href="#相关依赖配置" class="headerlink" title="相关依赖配置"></a>相关依赖配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br>         xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>         xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>    &lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br><br>    &lt;groupId&gt;com.tho&lt;/groupId&gt;<br>    &lt;artifactId&gt;RabbitMQ&lt;/artifactId&gt;<br>    &lt;packaging&gt;pom&lt;/packaging&gt;<br>    &lt;version&gt;<span class="hljs-number">1.0</span>&lt;/version&gt;<br>    &lt;modules&gt;<br>        &lt;<span class="hljs-keyword">module</span>&gt;RabbitMQ-producer&lt;/<span class="hljs-keyword">module</span>&gt;<br>    &lt;/modules&gt;<br>    &lt;!--Springboot 依赖--&gt;<br>    &lt;parent&gt;<br>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;<br>        &lt;version&gt;<span class="hljs-number">2.1</span><span class="hljs-number">.5</span>.RELEASE&lt;/version&gt;<br>        &lt;relativePath /&gt;<br>    &lt;/parent&gt;<br>    &lt;!--相关配置--&gt;<br>    &lt;properties&gt;<br>        &lt;project.build.sourceEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.build.sourceEncoding&gt;<br>        &lt;project.reporting.outputEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.reporting.outputEncoding&gt;<br>        &lt;java.version&gt;<span class="hljs-number">1.8</span>&lt;/java.version&gt;<br>    &lt;/properties&gt;<br>    &lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>            &lt;!--使用自定义日志框架 屏蔽自带的日志框架--&gt;<br>            &lt;!--&lt;exclusions&gt;<br>                &lt;exclusion&gt;<br>                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>                    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;<br>                &lt;/exclusion&gt;<br>            &lt;/exclusions&gt;--&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br><br>        &lt;/dependency&gt;<br>        &lt;!--Springboot 整合RabbitMQ--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br><br>    &lt;/dependencies&gt;<br><br>&lt;/project&gt;<br></code></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">server.port</span>=<span class="hljs-string">8001</span><br><span class="hljs-meta">server.servlet.context-path</span>=<span class="hljs-string">/</span><br><br><span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">192.168.198.100</span><br><span class="hljs-meta">spring.rabbitmq.username</span>=<span class="hljs-string">tho</span><br><span class="hljs-meta">spring.rabbitmq.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-meta">spring.rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br><span class="hljs-meta">spring.rabbitmq.connection-timeout</span>=<span class="hljs-string">15000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## 启用消息确认模式</span><br><span class="hljs-meta">spring.rabbitmq.publisher-confirms</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## 设置return消息模式,注意要和mandatory一起去配合使用</span><br><span class="hljs-comment">## spring.rabbitmq.publisher-returns=true</span><br><span class="hljs-comment">## spring.rabbitmq.template.mandatory=true</span><br><br><span class="hljs-meta">spring.http.encoding.charset</span>=<span class="hljs-string">UTF-8</span><br><span class="hljs-meta">spring.jackson.date-format</span>=<span class="hljs-string">yyyy-MM-dd HH:mm:ss</span><br><span class="hljs-meta">spring.jackson.time-zone</span>=<span class="hljs-string">GMT+8</span><br><span class="hljs-meta">spring.jackson.default-property-inclusion</span>=<span class="hljs-string">non_null</span><br></code></pre></td></tr></table></figure>

<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tho.component;<br><br><br><span class="hljs-keyword">import</span> org.springframework.amqp.AmqpException;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.messaging.MessageHeaders;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.MessageBuilder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/4/20:01</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> RabbitMQ</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: RabbitMQSender</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: RabbitMQ消息发送者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQSender</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确认消息的回调消息监听，用于确认消息是否被Broker收到</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">final</span> RabbitTemplate.ConfirmCallback confirmCallback= <span class="hljs-keyword">new</span> RabbitTemplate.ConfirmCallback()&#123;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> correlationData 作为一个唯一的标识,标记消息是不是对应的返回</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> ack              消息是否落盘成功</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> cause             失败的一些异常信息</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-keyword">boolean</span> ack, String cause)</span> </span>&#123;<br><br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Date</span> 2021/12/4 20:08</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> message  具体的消息内容</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> properties 额外的附加属性</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Return</span> void</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@Description</span>: 对外发送消息的方法</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(Object message, Map&lt;String, Object&gt; properties)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">// 携带附加属性,需符合AMQP协议</span><br>        MessageHeaders mhs = <span class="hljs-keyword">new</span> MessageHeaders(properties);<br>        <span class="hljs-comment">// 构造消息</span><br>        Message&lt;?&gt; msg = MessageBuilder.createMessage(message, mhs);<br>        <span class="hljs-comment">// 采用 spring.rabbitmq.publisher-confirms=true 模式</span><br>        <span class="hljs-comment">// 消息确认模式 需要设定回调事件</span><br>        rabbitTemplate.setConfirmCallback(confirmCallback);<br>        <span class="hljs-comment">// 指定了业务唯一id</span><br>        CorrelationData cd = <span class="hljs-keyword">new</span> CorrelationData(UUID.randomUUID().toString());<br>        MessagePostProcessor mpp = <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> org.springframework.amqp.core.<span class="hljs-function">Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(org.springframework.amqp.core.Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;<br>                System.err.println(<span class="hljs-string">&quot;post to do: +  &quot;</span> + message);<br>                <span class="hljs-keyword">return</span> message;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 发送消息</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;exchange-1&quot;</span>, <span class="hljs-string">&quot;springboot.rabbit&quot;</span>,<br>                msg,<br>                mpp,<br>                cd);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-消费者"><a href="#2-消费者" class="headerlink" title="2.消费者"></a>2.消费者</h3><h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">server.port</span>=<span class="hljs-string">8002</span><br><span class="hljs-meta">server.servlet.context-path</span>=<span class="hljs-string">/</span><br><br><span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">192.168.198.100</span><br><span class="hljs-meta">spring.rabbitmq.username</span>=<span class="hljs-string">tho</span><br><span class="hljs-meta">spring.rabbitmq.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-meta">spring.rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br><span class="hljs-meta">spring.rabbitmq.connection-timeout</span>=<span class="hljs-string">15000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## 消费者消费成功后需要手工进行签收(ack),默认为auto</span><br><span class="hljs-meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="hljs-string">manual</span><br><span class="hljs-meta">spring.rabbitmq.listener.simple.concurrency</span>=<span class="hljs-string">5</span><br><span class="hljs-meta">spring.rabbitmq.listener.simple.prefetch</span>=<span class="hljs-string">1</span><br><span class="hljs-meta">spring.rabbitmq.listener.simple.max-concurrency</span>=<span class="hljs-string">10</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## 自定义配置</span><br><span class="hljs-comment">## 最好不要在代码里将配置固定,尽量使用配置文件使用$&#123;&#125;来获取参数</span><br><span class="hljs-meta">spring.rabbitmq.listener.order.exchange.name</span>=<span class="hljs-string">exchange-1</span><br><br><span class="hljs-meta">spring.http.encoding.charset</span>=<span class="hljs-string">UTF-8</span><br><span class="hljs-meta">spring.jackson.date-format</span>=<span class="hljs-string">yyyy-MM-dd HH:mm:ss</span><br><span class="hljs-meta">spring.jackson.time-zone</span>=<span class="hljs-string">GMT+8</span><br><span class="hljs-meta">spring.jackson.default-property-inclusion</span>=<span class="hljs-string">non_null</span><br></code></pre></td></tr></table></figure>

<h4 id="组件-1"><a href="#组件-1" class="headerlink" title="组件"></a>组件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tho.consumer.component;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.*;<br><span class="hljs-keyword">import</span> org.springframework.amqp.support.AmqpHeaders;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/4/20:27</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> RabbitMQ</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: RabbitMQReceiver</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: RabbitMQ消费者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQReceiver</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 组合使用监听</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@RabbitListener</span>  <span class="hljs-doctag">@QueueBinding</span> <span class="hljs-doctag">@Queue</span> <span class="hljs-doctag">@Exchange</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(</span><br><span class="hljs-meta">            bindings = @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue(value = &quot;queue-1&quot;, durable = &quot;true&quot;),</span><br><span class="hljs-meta">                    exchange = @Exchange(name = &quot;$&#123;spring.rabbitmq.listener.order.exchange.name&#125;&quot;,</span><br><span class="hljs-meta">                            durable = &quot;true&quot;,</span><br><span class="hljs-meta">                            type = &quot;topic&quot;,</span><br><span class="hljs-meta">                            ignoreDeclarationExceptions = &quot;true&quot;),</span><br><span class="hljs-meta">                    key = &quot;springboot.*&quot;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">// 1.收到消息后进行业务端消费处理</span><br>        System.err.println(<span class="hljs-string">&quot;----------------------&quot;</span>);<br>        System.err.println(<span class="hljs-string">&quot;消费消息&quot;</span> + message.getPayload());<br><br>        <span class="hljs-comment">// 2.处理成功之后,获取 deliveryTag 并进行手工的Ack操作，因为配置文件里配置了手工签收</span><br>        <span class="hljs-comment">// ## 消费者消费成功后需要手工进行签收(ack),默认为auto</span><br>        <span class="hljs-comment">// spring.rabbitmq.listener.simple.acknowledge-mode=manual</span><br>        Long deliveryTag = (Long) message.getHeaders().get(AmqpHeaders.DELIVERY_TAG);<br>        channel.basicAck(deliveryTag, <span class="hljs-keyword">false</span>);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-可能会报错"><a href="#3-可能会报错" class="headerlink" title="3.可能会报错"></a>3.可能会报错</h3><blockquote>
<p>RabbitMQ默认端口是5672</p>
<p>配置文件输入host时仅需要输入ip地址即可</p>
<p>配置文件中有关于端口的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.rabbitmq.port=<span class="hljs-number">5672</span><br></code></pre></td></tr></table></figure>
</blockquote>
<p>RabbitMQ设置了自己的用户,需要进入控制面板给自己的用户相应的权限</p>
<blockquote>
<p>Admin选项</p>
<p>点击自己设定的用户</p>
<p>点击 Set permission 设定权限</p>
</blockquote>
<h3 id="4-测试整合是否成功"><a href="#4-测试整合是否成功" class="headerlink" title="4.测试整合是否成功"></a>4.测试整合是否成功</h3><h4 id="启动消费者项目"><a href="#启动消费者项目" class="headerlink" title="启动消费者项目"></a>启动消费者项目</h4><ul>
<li>进入RabbitMQ,可以看到设定了相应的exchange和queue</li>
<li>Overview 和 Connections 界面也发生了一些变化</li>
</ul>
<h4 id="启动生产者的组件-进行测试"><a href="#启动生产者的组件-进行测试" class="headerlink" title="启动生产者的组件,进行测试"></a>启动生产者的组件,进行测试</h4><p>消费者的测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test.producer;<br><br><span class="hljs-keyword">import</span> com.tho.Application;<br><span class="hljs-keyword">import</span> com.tho.producer.component.RabbitMQSender;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> tho</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/4/20:58</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ProjectName</span> RabbitMQ</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span>: ApplicationTests</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: RabbitMQ生产者的测试类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = Application.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationTests</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitMQSender rabbitMQSender;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SenderTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br><br>        Map&lt;String, Object&gt; properties = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        properties.put(<span class="hljs-string">&quot;attr1&quot;</span>, <span class="hljs-string">&quot;12&quot;</span>);<br>        properties.put(<span class="hljs-string">&quot;attr2&quot;</span>, <span class="hljs-string">&quot;abc&quot;</span>);<br>        rabbitMQSender.send(<span class="hljs-string">&quot;hello rabbitMQ&quot;</span>, properties);<br><br>        Thread.sleep(<span class="hljs-number">10000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-7、RabbitMQ集群架构模式"><a href="#2-7、RabbitMQ集群架构模式" class="headerlink" title="2.7、RabbitMQ集群架构模式"></a>2.7、RabbitMQ集群架构模式</h2><h3 id="1-主备模式"><a href="#1-主备模式" class="headerlink" title="1.主备模式"></a>1.主备模式</h3><blockquote>
<p>主从模式 主节点可以读写 从节点只能读</p>
<p>主备模式 主节点正常提供服务,从节点不提供任何服务(主节点宕机,备用节点提供新的服务)</p>
</blockquote>
<ul>
<li><p>实现RabbitMQ的高可用集群,一般在并发和数据量也不高的情况下,这种模型非常好用且简单。主备模式也称之为Warrent模式</p>
</li>
<li><p>一般在并发和数据量不高的情况下使用主备模式,配置简单,维护简单 中小型公司常用 </p>
</li>
<li><p>借助Haproxy实现主备模式</p>
</li>
</ul>
<h3 id="2-远程模式"><a href="#2-远程模式" class="headerlink" title="2.远程模式"></a>2.远程模式</h3><ul>
<li>远程模式可以实现双活的一种模式，简称Shovel模式,Shovel就是我们可以把消息进行不同数据中心的复制工作，我们可以跨地域地让两个mq集群互联</li>
<li>借助 rabbitmq_shovel 插件实现</li>
</ul>
<h3 id="3-镜像模式"><a href="#3-镜像模式" class="headerlink" title="3.镜像模式"></a>3.镜像模式</h3><ul>
<li>集群最经典的就是Mirror镜像模式,保证100%数据不丢失，在实际工作中也是用的最多的。并且实现集群非常简单</li>
<li>为了保证RabbitMQ数据的高可靠性方案，对于100%数据可靠性一般是三个节点</li>
</ul>
<h1 id="三、RabbitMQ基础组件封装"><a href="#三、RabbitMQ基础组件封装" class="headerlink" title="三、RabbitMQ基础组件封装"></a>三、RabbitMQ基础组件封装</h1><h2 id="3-1、基础组件关键点"><a href="#3-1、基础组件关键点" class="headerlink" title="3.1、基础组件关键点"></a>3.1、基础组件关键点</h2><ul>
<li>一线大厂MQ组件实现思路和架构设计方案</li>
<li>基础组件封装设计-迅速消息发送</li>
<li>基础组件封装设计-确认消息发送</li>
<li>基础组件封装设计-延迟消息发送</li>
</ul>
<blockquote>
<p>基础组件实现功能点</p>
<ul>
<li>迅速，延迟，可靠</li>
<li>消息异步化，序列化</li>
<li>连接池化，高性能</li>
<li>完备的补偿机制</li>
</ul>
</blockquote>
<h2 id="3-2、基础组件模块"><a href="#3-2、基础组件模块" class="headerlink" title="3.2、基础组件模块"></a>3.2、基础组件模块</h2><p>父工程 pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.tho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>RabbitMQ<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>RabbitMQ-producer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>RabbitMQ-consumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--Springboot 依赖--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--相关配置--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">fasterxml.uuid.version</span>&gt;</span>3.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">fasterxml.uuid.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">org.codehaus.jackson.version</span>&gt;</span>2.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">org.codehaus.jackson.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">druid.version</span>&gt;</span>1.0.24<span class="hljs-tag">&lt;/<span class="hljs-name">druid.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">elastic-job.version</span>&gt;</span>2.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">elastic-job.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">guava.version</span>&gt;</span>20.0<span class="hljs-tag">&lt;/<span class="hljs-name">guava.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons-lang3.version</span>&gt;</span>3.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">commons-lang3.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons-io.version</span>&gt;</span>2.4<span class="hljs-tag">&lt;/<span class="hljs-name">commons-io.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons-collections.version</span>&gt;</span>3.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">commons-collections.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">curator.version</span>&gt;</span>2.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">curator.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">fastjson.version</span>&gt;</span>1.1.26<span class="hljs-tag">&lt;/<span class="hljs-name">fastjson.version</span>&gt;</span><br><br><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--使用自定义日志框架 屏蔽自带的日志框架--&gt;</span><br>            <span class="hljs-comment">&lt;!--&lt;exclusions&gt;</span><br><span class="hljs-comment">                &lt;exclusion&gt;</span><br><span class="hljs-comment">                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="hljs-comment">                    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br><span class="hljs-comment">                &lt;/exclusion&gt;</span><br><span class="hljs-comment">            &lt;/exclusions&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--Springboot 整合RabbitMQ--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;guava.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;commons-io.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--对json格式的支持--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.jackson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-mapper-asl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.uuid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-uuid-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fasterxml.uuid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>RabbitMQ-common ：一些通用模块</li>
<li>RabbitMQ-api：对外提供接口模块</li>
<li>RabbitMQ-task：一些定时任务</li>
<li>RabbitMQ-core-producer：延迟发送等业务实现</li>
</ul>
<h2 id="3-3、API模块封装"><a href="#3-3、API模块封装" class="headerlink" title="3.3、API模块封装"></a>3.3、API模块封装</h2><blockquote>
<p>serialVersionUID IDea自动生成需要在设置里进行设置</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hetongun/article/details/81904393">https://blog.csdn.net/hetongun/article/details/81904393</a></p>
</blockquote>
<h2 id="3-4、消息的可靠性投递"><a href="#3-4、消息的可靠性投递" class="headerlink" title="3.4、消息的可靠性投递"></a>3.4、消息的可靠性投递</h2><h3 id="1-集成数据源"><a href="#1-集成数据源" class="headerlink" title="1.集成数据源"></a>1.集成数据源</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>RabbitMQ<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.tho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>RabbitMQ-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.tho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>RabbitMQ-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--mysql驱动--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.41<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>需要的 broker_message 表 消息投递日志表</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 表 rabbitmq.broker_message 结构</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `broker_message` (<br>	`message_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`message` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">3600</span>),<br>	`try_count` <span class="hljs-type">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>	`status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>	`next_retry` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;2019-07-01 00:00:00&#x27;</span>,<br>	`create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-07-01 12:26:55&#x27;</span>,<br>	`update_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;2019-07-01 06:06:55&#x27;</span>,<br>	<span class="hljs-keyword">PRIMARY</span> KEY (`message_id`)<br><br>)ENGINE<span class="hljs-operator">=</span>INNODB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<h2 id="3-5、消息补偿"><a href="#3-5、消息补偿" class="headerlink" title="3.5、消息补偿"></a>3.5、消息补偿</h2><blockquote>
<p>elastic job 当当网</p>
<p>分布式定时任务</p>
</blockquote>
<h1 id="四、分布式定时任务"><a href="#四、分布式定时任务" class="headerlink" title="四、分布式定时任务"></a>四、分布式定时任务</h1><h2 id="4-1、Elastic-Job"><a href="#4-1、Elastic-Job" class="headerlink" title="4.1、Elastic-Job"></a>4.1、Elastic-Job</h2><ul>
<li>需要借助zookeeper实现,需要配置好zookeeper环境</li>
</ul>
<blockquote>
<p>可以通过zookeeper来修改elastic-job的相关参数</p>
<p>利用ealstic-job的后台管理程序进行修改,可以更方便地修改elastic-job</p>
<p>后台还可以查看定时任务的执行日志记录</p>
</blockquote>
<h2 id="4-2、SimpleJob"><a href="#4-2、SimpleJob" class="headerlink" title="4.2、SimpleJob"></a>4.2、SimpleJob</h2><ul>
<li>最简单的job</li>
</ul>
<h2 id="4-3、DataFlowJob"><a href="#4-3、DataFlowJob" class="headerlink" title="4.3、DataFlowJob"></a>4.3、DataFlowJob</h2><ul>
<li>可以实时抓取数据的Job</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/RabbitMQ/">RabbitMQ</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章可随意转载
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/12/26/Zookeeper/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">分布式锁</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/11/30/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D/">
                        <span class="hidden-mobile">分布式会话</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
