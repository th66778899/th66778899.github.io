

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/mario.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="分库分表常见解决方案">
  <meta name="author" content="tho">
  <meta name="keywords" content="">
  <meta name="description" content="分库分表常见解决方案">
<meta property="og:type" content="article">
<meta property="og:title" content="分库分表">
<meta property="og:url" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/index.html">
<meta property="og:site_name" content="Tho668&#39;s Blogs">
<meta property="og:description" content="分库分表常见解决方案">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20211223215410373.png">
<meta property="og:image" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20211229125856871.png">
<meta property="og:image" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20220101114327186.png">
<meta property="og:image" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20220101152521852.png">
<meta property="article:published_time" content="2021-12-26T07:30:56.000Z">
<meta property="article:modified_time" content="2022-03-04T14:26:38.527Z">
<meta property="article:author" content="tho">
<meta property="article:tag" content="分库分表">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2021/12/26/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20211223215410373.png">
  
  <title>分库分表 - Tho668&#39;s Blogs</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tho668</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/galaxy.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="分库分表">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-12-26 15:30" pubdate>
        December 26, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      28k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      88 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">分库分表</h1>
            
            <div class="markdown-body">
              <p>分库分表常见解决方案</p>
<span id="more"></span>



<p>yum配置阿里镜像源 </p>
<blockquote>
<p>1）下载repo文件<br>wget <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/repo/Centos-7.repo">http://mirrors.aliyun.com/repo/Centos-7.repo</a></p>
<p>wget命令不存在 使用 yum进行安装即可  </p>
<p>yum install -y wget</p>
<p>2）备份并替换系统的repo文件</p>
<p>cp Centos-7.repo /etc/yum.repos.d/<br>cd /etc/yum.repos.d/<br>mv CentOS-Base.repo CentOS-Base.repo.bak<br>mv Centos-7.repo CentOS-Base.repo</p>
<p>3）执行yum源更新命令</p>
<p>yum clean all<br>yum makecache<br>yum update</p>
<p>配置完毕。</p>
</blockquote>
<h1 id="一、分库分表"><a href="#一、分库分表" class="headerlink" title="一、分库分表"></a>一、分库分表</h1><h2 id="1-1、切分数据库"><a href="#1-1、切分数据库" class="headerlink" title="1.1、切分数据库"></a>1.1、切分数据库</h2><p>水平切分 ：按照表的属性名进行切分</p>
<p>垂直切分 ：按照 userId 的哈希值或者一定规则将表中数据切分为不同的组成 </p>
<ul>
<li>分布式事务问题</li>
<li>跨库join问题</li>
<li>多数据源的管理问题</li>
</ul>
<blockquote>
<p>针对多数据源的管理问题,主要有两种思路：</p>
<ol>
<li>客户端模式，在每个应用模块内，配置自己需要的数据源，直接访问数据库，在各模块内完成数据的整合</li>
<li>中间代理模式，中间代理统一管理所有的数据源，数据库层对开发人员完全透明，开发人员无需关注拆分的细节</li>
</ol>
</blockquote>
<ul>
<li>中间代理模式：MyCat</li>
<li>客户端模式:sharding-jdbc</li>
</ul>
<h2 id="1-2、读写分离"><a href="#1-2、读写分离" class="headerlink" title="1.2、读写分离"></a>1.2、读写分离</h2><ul>
<li>数据库分为读库和写库 写库中的数据更新要同步到读库</li>
</ul>
<h2 id="1-3、垂直切分"><a href="#1-3、垂直切分" class="headerlink" title="1.3、垂直切分"></a>1.3、垂直切分</h2><ul>
<li>按照业务切分</li>
<li>每种业务一个数据库</li>
<li>不同业务之间，禁止跨库join联查(性能太差，一般通过服务来进行查询)</li>
</ul>
<blockquote>
<p>垂直切分</p>
<p>优点：</p>
<ul>
<li>拆分后业务清晰，拆分规则明确</li>
<li>系统之间容易扩展和整合</li>
<li>数据维护简单</li>
</ul>
<p>缺点：</p>
<ul>
<li>部分业务表无法join，只能通过接口调用，提升了系统的复杂度</li>
<li>跨库事务难以处理</li>
<li>垂直切分后，某些业务数据过于庞大，仍然存在单体性能瓶颈</li>
</ul>
</blockquote>
<h2 id="1-4、水平切分"><a href="#1-4、水平切分" class="headerlink" title="1.4、水平切分"></a>1.4、水平切分</h2><ul>
<li>将一张表的数据按照某种规则分到不同的数据库中</li>
<li>需确定分片的规则</li>
<li>使用分片字段查询时，可确定实体库，其它字段查询，查询所有表</li>
</ul>
<blockquote>
<p>水平切分</p>
<p>优点：</p>
<ul>
<li>解决了单库大数据，高并发的性能瓶颈</li>
<li>拆分规则封装好，对应用端几乎透明，开发人员无需关心拆分细节</li>
<li>提高了系统的稳定性和负载能力</li>
</ul>
<p>缺点：</p>
<ul>
<li>拆分规则很难抽象</li>
<li>分片事务一致性难以解决</li>
<li>二次扩展时，数据迁移，维护难度大</li>
</ul>
</blockquote>
<h2 id="1-5、分库分表选择"><a href="#1-5、分库分表选择" class="headerlink" title="1.5、分库分表选择"></a>1.5、分库分表选择</h2><ul>
<li>优先选择垂直切分</li>
<li>之后选择水平切分</li>
</ul>
<h1 id="二、MyCat"><a href="#二、MyCat" class="headerlink" title="二、MyCat"></a>二、MyCat</h1><h2 id="2-1、MyCat概述"><a href="#2-1、MyCat概述" class="headerlink" title="2.1、MyCat概述"></a>2.1、MyCat概述</h2><ul>
<li>对于DBA来说： MyCat就是MySql ， 而MyCat后面连接的mysql可以理解为mysql的存储引擎，比如：myisam，innodb等，mycat本身并不存储数据，数据都是存储在mycat后面连接的mysql上，数据的可靠性和事务都是mysql保证的</li>
<li>对于开发人员来说： mycat就是一个近似等于mysql的数据库服务，可以使用连接mysql的方式连接mycat。绝大多数情况，可以使用常用的orm框架连接mycat，但是对于分片的表，建议使用标准的sql语句，这样能够达到最佳的性能</li>
<li>对于架构师来说： mycat是一个强大的数据库中间件，不仅仅可以用作读写分离，分库分表，还可以用于容灾备份，云平台建设等，让架构具备更强的适应性和灵活性</li>
</ul>
<blockquote>
<p>MyCat的应用场景</p>
<p>MyCat发展到现在，使用的场景很丰富，常见的典型应用场景有</p>
<ul>
<li>单纯的读写分离，此时配置最为简单，支持读写分离，主从切换</li>
<li>分库分表，对于超过1000w的表进行分片，最大支持1000亿的数据</li>
<li>多租户应用，每个应用一个数据库，应用只连接MyCat，程序本身不需要改造</li>
<li>代替Hbase，分析大数据</li>
</ul>
</blockquote>
<h2 id="2-2、MyCat基本概念"><a href="#2-2、MyCat基本概念" class="headerlink" title="2.2、MyCat基本概念"></a>2.2、MyCat基本概念</h2><p>MyCat是一个数据库的中间件，介于应用和数据库之间，是进行数据处理和交互的中间服务</p>
<h3 id="1-逻辑库-Schema"><a href="#1-逻辑库-Schema" class="headerlink" title="1.逻辑库(Schema)"></a>1.逻辑库(Schema)</h3><ul>
<li>在实际的开发中，开发人员不需要知道数据库中间件的存在，开发人员只需要有数据库的概念就可以了，所以数据库中间件可以被看做一个或者多个数据库集群构成的逻辑库</li>
</ul>
<h3 id="2-逻辑表-table"><a href="#2-逻辑表-table" class="headerlink" title="2.逻辑表(table)"></a>2.逻辑表(table)</h3><ul>
<li>既然有逻辑库，就有逻辑表，对于应用系统来说，读写数据的表，就是逻辑表。而逻辑表中的数据则是被水平切分之后，分布在不同的分片库中。</li>
<li>假设用户库中有一张用户表，这个用户表就被称为逻辑表，而用户表又被水平切分为3个表，每一个逻辑表中都存储一部分用户数据。业务系统在对用户数据进行读写时，只需要操作逻辑表就可以了，后面的分片细节则由MyCat来进行操作，这对于业务开发人员来说是完全透明的。当然，有些表的数据量没有那么大，完全不需要进行分片，只在一个物理的数据库表中即可</li>
<li>凡是做的数据水平切分的表，都叫做分片表。而数据量较小，没有进行分片的表，叫做非分片表</li>
<li>在真实的业务系统中，往往存在着大量的字典表，这些表的数据基本上很少变动，比如：订单状态。查询的时候往往需要关联字段表去查询，比如：查询订单时，需要把订单状态关联查出，如果订单表做了分片，分布在不同的数据库中，而订单状态由于数据量小，没有做分片，那么我们查询的时候就要跨库关联查询订单状态，增加了不必要的麻烦，不如把订单状态冗余到所有的订单分片库中，这样关联查询就不需要跨库了，我们把这种通过数据冗余方式复制到所有分片库中的表 叫做==全局表==</li>
</ul>
<h3 id="3-分片节点-dataNode"><a href="#3-分片节点-dataNode" class="headerlink" title="3.分片节点(dataNode)"></a>3.分片节点(dataNode)</h3><ul>
<li>数据被切分后，一张大表被分到不同的分片数据库上面，每个分片表所在的数据库就叫做==分片节点==</li>
</ul>
<h3 id="4-分片主机-dataHost"><a href="#4-分片主机-dataHost" class="headerlink" title="4.分片主机(dataHost)"></a>4.分片主机(dataHost)</h3><ul>
<li>数据切分后，每一个分片节点不一定都会占用一个真正的物理主机，会存在多个分片节点在同一个物理主机上的情况，这些分片节点所在的主机就叫做==节点主机==，为了避免单节点并发数的限制，尽量将读写压力高的分片节点放在不同的节点主机上</li>
</ul>
<h3 id="5-分片规则-rule"><a href="#5-分片规则-rule" class="headerlink" title="5.分片规则(rule)"></a>5.分片规则(rule)</h3><ul>
<li>一个大表被拆分成多个分片表，就需要一定的规则，按照某种业务逻辑，将数据分到一个确定的分片当中，这个规则就叫做==分片规则==。数据切分选择合适的分片规则非常重要，这将影响到后续的数据处理难度，结合业务，选择合适的分片规则是一个艰难的，难以抉择的过程</li>
</ul>
<h3 id="6-全局序列号-sequence"><a href="#6-全局序列号-sequence" class="headerlink" title="6.全局序列号(sequence)"></a>6.全局序列号(sequence)</h3><ul>
<li>数据切分之后，数据库中的id怎么办，原来在一张表的时候，采用id自增，数据分布到多个数据可怎么办？比如向用户表插入数据，第一条记录插入了用户库1，id为1，第二条记录插入了用户库2，如果是自增，他的id也为1，这样就太混乱了，也无法确定一条数据的唯一标识了，我们需要借助外部机制来保证数据的唯一标识，这种保证数据唯一标识的机制，就是 ==全局序列号==</li>
</ul>
<h2 id="2-3、Mycat环境搭建"><a href="#2-3、Mycat环境搭建" class="headerlink" title="2.3、Mycat环境搭建"></a>2.3、Mycat环境搭建</h2><h3 id="1-mysql环境搭建"><a href="#1-mysql环境搭建" class="headerlink" title="1.mysql环境搭建"></a>1.mysql环境搭建</h3><blockquote>
<p>三台虚拟机 两台安装mysql 一台安装Mycat，并修改配置文件</p>
</blockquote>
<ul>
<li>使用yum方式安装mysql (查看官网教程)</li>
<li>手动安装</li>
</ul>
<p> 两台虚拟机配置好mysql环境</p>
<h3 id="2-mycat环境搭建"><a href="#2-mycat环境搭建" class="headerlink" title="2.mycat环境搭建"></a>2.mycat环境搭建</h3><p>解压mycat安装包到 /usr/local/mycat-1.6 目录下</p>
<blockquote>
<p>/conf 目录下下 修改配置文件</p>
<p>server.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">defaultAccount</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>123456<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;schemas&quot;</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<br>		<span class="hljs-comment">&lt;!-- 表级 DML 权限设置 --&gt;</span><br>		<span class="hljs-comment">&lt;!-- 		</span><br><span class="hljs-comment">		&lt;privileges check=&quot;false&quot;&gt;</span><br><span class="hljs-comment">			&lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;</span><br><span class="hljs-comment">				&lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;</span><br><span class="hljs-comment">				&lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;</span><br><span class="hljs-comment">			&lt;/schema&gt;</span><br><span class="hljs-comment">		&lt;/privileges&gt;		</span><br><span class="hljs-comment">		 --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;schemas&quot;</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;readOnly&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>schema.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- dataHost 配置 (对应mysql节点所在主机) --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;db101&quot;</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">&quot;1000&quot;</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">			  <span class="hljs-attr">writeType</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">&quot;mysql&quot;</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">&quot;native&quot;</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- can have multi write hosts --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;M1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.198.101:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>			<span class="hljs-comment">&lt;!-- can have multi read hosts --&gt;</span><br>			<span class="hljs-comment">&lt;!--&lt;readHost host=&quot;hostS2&quot; url=&quot;192.168.1.200:3306&quot; user=&quot;root&quot; password=&quot;xxx&quot; /&gt;--&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br>		<br>		<span class="hljs-comment">&lt;!--&lt;writeHost host=&quot;hostS1&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot;</span><br><span class="hljs-comment">				   password=&quot;123456&quot; /&gt;--&gt;</span><br>		<span class="hljs-comment">&lt;!-- &lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&gt; --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;db102&quot;</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">&quot;1000&quot;</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">			  <span class="hljs-attr">writeType</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">&quot;mysql&quot;</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">&quot;native&quot;</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- can have multi write hosts --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;M1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.198.102:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>			<span class="hljs-comment">&lt;!-- can have multi read hosts --&gt;</span><br>			<span class="hljs-comment">&lt;!--&lt;readHost host=&quot;hostS2&quot; url=&quot;192.168.1.200:3306&quot; user=&quot;root&quot; password=&quot;xxx&quot; /&gt;--&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br>		<br>		<span class="hljs-comment">&lt;!--&lt;writeHost host=&quot;hostS1&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot;</span><br><span class="hljs-comment">				   password=&quot;123456&quot; /&gt;--&gt;</span><br>		<span class="hljs-comment">&lt;!-- &lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&gt; --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- dataNode 配置--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn101&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;db101&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;user_101&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn102&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;db102&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;user_102&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 分片规则配置 --&gt;</span><br><span class="hljs-comment">&lt;!-- schema name=&quot;user&quot;  配置文件 中的name 要保持一致 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- auto sharding by id (long) --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn101,dn102&quot;</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">&quot;auto-sharding-long&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br></code></pre></td></tr></table></figure>

</blockquote>
<h3 id="3-启动mycat"><a href="#3-启动mycat" class="headerlink" title="3.启动mycat"></a>3.启动mycat</h3><blockquote>
<p>./bin/mycat console – 可以查看mycat的日志信息</p>
<p>启动报错 ： Caused by: io.mycat.config.util.ConfigException: Illegal table conf : table [ USER ] rule function [ rang-long ] partition size : 3 &gt; table datanode size : 2, please make sure table datanode size = function partition size</p>
<p>使用的分片算法 是将数据分为三个分片,但是现在配置的mysql数据库只有两个</p>
</blockquote>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"># range start-end ,data node index<br># K=<span class="hljs-number">1000</span>,M=<span class="hljs-number">10000.</span><br><span class="hljs-number">0</span>-500M=<span class="hljs-number">0</span><br>500M-1000M=<span class="hljs-number">1</span><br># 1000M-1500M=<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>


</blockquote>
<h3 id="4-测试-mycat"><a href="#4-测试-mycat" class="headerlink" title="4.测试 mycat"></a>4.测试 mycat</h3><blockquote>
<p>连接mycat 在mycat服务器上进行数据的插入,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> `<span class="hljs-keyword">user</span>` (id, user_name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, &quot;tho&quot;)<br></code></pre></td></tr></table></figure>

<p>记录物理保存在  198.101 服务器的mysql上</p>
<p>根据指定的分片规则 0 - 500w 数据都保存在 101 服务器上</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> `<span class="hljs-keyword">user</span>` (id, user_name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">6000000</span>, &quot;tho&quot;)<br></code></pre></td></tr></table></figure>

<p>插入一条 600000w id 的数据 该数据会保存到 102服务器上</p>
</blockquote>
<h2 id="2-4、Mycat用户配置"><a href="#2-4、Mycat用户配置" class="headerlink" title="2.4、Mycat用户配置"></a>2.4、Mycat用户配置</h2><h3 id="1-server-xml-配置"><a href="#1-server-xml-配置" class="headerlink" title="1.server.xml 配置"></a>1.server.xml 配置</h3><ul>
<li>配置MyCat 的用户名，密码，权限，Schema 等</li>
<li>如同给 mysql 新建用户一样</li>
<li>客户端连接MyCat 与 连接mysql 无异</li>
</ul>
<h3 id="2-直接使用-mysql8-0-cli-连接mycat"><a href="#2-直接使用-mysql8-0-cli-连接mycat" class="headerlink" title="2.直接使用 mysql8.0 cli 连接mycat"></a>2.直接使用 mysql8.0 cli 连接mycat</h3><p><img src="%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20211223215410373.png" srcset="/img/loading.gif" lazyload alt="image-20211223215410373"></p>
<blockquote>
<p>因为mysql8.0 加密方式的变化 使用mysql8.0 cli 客户端可能无法直接连接mycat</p>
<p>mysql8.0 cli 客户端 使用的是新的加密方式 </p>
<p>使用旧的加密方式</p>
<p><code>mysql -uroot -p8066 -h127.0.0.1 --default-auth=mysql_native_password </code> 输入密码 连接mycat </p>
</blockquote>
<h3 id="3-schema-xml配置"><a href="#3-schema-xml配置" class="headerlink" title="3.schema.xml配置"></a>3.schema.xml配置</h3><ul>
<li>配置 dataHost(节点主机) ， 包括读host ， 写 host</li>
<li>配置 dataNode(数据节点) ， 指定到具体的数据库</li>
<li>配置 schema， 表名，数据节点，分片规则</li>
</ul>
<blockquote>
<ul>
<li>balance 配置 ： 负载均衡类型 <ul>
<li>0 不开启读写分离</li>
<li>1 和 2 读写均分配</li>
<li>3 读落在 readHost 上</li>
</ul>
</li>
<li>writeType 配置 ：写请求类型 0 落在第一个 writeHost 上 ；1 随机</li>
<li>sqlMaxLimit ：会拦截sql 自动加上 limit 条件 (sql语句本身有limit mycat的 limit 便不会再生效)</li>
<li>checkSQLschema：是否去掉 SQL 中的 Schema</li>
<li>table 标签：定义表<ul>
<li>name属性：定义逻辑表的表名</li>
<li>dataNode属性：定义逻辑表的数据节点</li>
</ul>
</li>
<li>rule属性：定义分片表的分配规则，必须与rule.xml 中的tableRule对应</li>
<li>ruleRequired属性：是否绑定分配规则，如果为 true 但是没有绑定分片规则,会报错</li>
</ul>
</blockquote>
<h2 id="2-5、验证MyCat-配置"><a href="#2-5、验证MyCat-配置" class="headerlink" title="2.5、验证MyCat 配置"></a>2.5、验证MyCat 配置</h2><p>使用命令 <code>./bin/mycat start</code> 后台启动 mycat</p>
<blockquote>
<p>使用 mycat 9066 端口可以 不停机查看 更新mycat中的配置</p>
</blockquote>
<h2 id="2-6、配置读写分离"><a href="#2-6、配置读写分离" class="headerlink" title="2.6、配置读写分离"></a>2.6、配置读写分离</h2><p>schema.xml 配置文件修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;M1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.198.101:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>			<span class="hljs-comment">&lt;!-- can have multi read hosts --&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">readHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;S1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.198.100:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>198.100 服务器配置好 mysql 服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">连接mycat的管理端口 <span class="hljs-number">9066</span> 使用 `show @<span class="hljs-meta">@help</span>;` 查看所有命令<br>  使用 修改了 schema.xml 中 数据源 相关的内容,需要使用命令 reload @<span class="hljs-meta">@config_all</span>; 来使配置生效<br></code></pre></td></tr></table></figure>

<h2 id="2-7、Mysql主从配置"><a href="#2-7、Mysql主从配置" class="headerlink" title="2.7、Mysql主从配置"></a>2.7、Mysql主从配置</h2><ul>
<li>主配置 log-bin  指定文件的名字</li>
<li>主配置 server-id 默认为1</li>
<li>从配置 server-id 与主不能重复</li>
</ul>
<h3 id="1-主从配置文件配置"><a href="#1-主从配置文件配置" class="headerlink" title="1.主从配置文件配置"></a>1.主从配置文件配置</h3><blockquote>
<p>主mysql 配置文件 my.cnf 配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"># 配置mysql主从<br>log-bin=tho_mysql<br>server-id=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>


</blockquote>
<blockquote>
<p> 从mysql 配置文件 my.cnf 配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">server-id=<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>重启 主从数据库</p>
</blockquote>
<h3 id="2-创建备份用账号"><a href="#2-创建备份用账号" class="headerlink" title="2.创建备份用账号"></a>2.创建备份用账号</h3><blockquote>
<p>主数据库创建备份账号并授权 REPLICATION SLAVE </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;repl&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>; <br>(两个数据库都是mysql8<span class="hljs-number">.0</span> 不需要考虑加密方式的问题,两个数据库都使用mysql8<span class="hljs-number">.0</span>默认的加密方式)<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">grant</span> replication slave <span class="hljs-keyword">on</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">to</span> <span class="hljs-string">&#x27;repl&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> flush privileges;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>主 进行锁表 </p>
<p>FLUSH TABLES WITH READ LOCK;</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> flush tables <span class="hljs-keyword">with</span> read lock;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.01</span> sec)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>主数据库 找到 log-bin 的位置 </p>
<p>show master status;</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> master status;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> File             <span class="hljs-operator">|</span> Position <span class="hljs-operator">|</span> Binlog_Do_DB <span class="hljs-operator">|</span> Binlog_Ignore_DB <span class="hljs-operator">|</span> Executed_Gtid_Set <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> tho_mysql<span class="hljs-number">.000001</span> <span class="hljs-operator">|</span>      <span class="hljs-number">739</span> <span class="hljs-operator">|</span>              <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>                   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>主 备份数据 </p>
<p>mysqldump –all-databases –master-data &gt; dbdump.db</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">在执行mysqldump命令时候报如下错误：<br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-operator">~</span>]#  mysqldump <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-comment">--all-databases&gt; all.sql   </span><br><br>mysqldump: Got error: <span class="hljs-number">2002</span>: Can<span class="hljs-string">&#x27;t connect to local MySQL server through socket &#x27;</span><span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>mysql<span class="hljs-operator">/</span>mysql.sock<span class="hljs-string">&#x27; (2) when trying to connect</span><br><span class="hljs-string"></span><br><span class="hljs-string">找到正确的套接字的路径： </span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos_7_100 mycat]# netstat -ln | grep mysql    </span><br><span class="hljs-string">unix  2      [ ACC ]     STREAM     LISTENING     29653    /var/lib/mysql/mysql.sock</span><br><span class="hljs-string">[root@centos_7_100 mycat]# </span><br><span class="hljs-string">[root@centos_7_100 mycat]# mysqldump --socket=/var/lib/mysql/mysql.sock --all-databases --master-data &gt; dbdump.db -uroot -p</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>从 数据库 拷贝主数据库的备份文件</p>
<p>scp <a href="mailto:&#114;&#111;&#x6f;&#x74;&#64;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x31;&#x39;&#x38;&#x2e;&#x31;&#x30;&#x30;">&#114;&#111;&#x6f;&#x74;&#64;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x31;&#x39;&#x38;&#x2e;&#x31;&#x30;&#x30;</a>:~/dbdump.db .</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 备份到从数据库</span><br>[root<span class="hljs-meta">@centos_7_101</span> ~]# mysql &lt; dbdump.db -uroot -p<br>Enter password: <br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>放开锁表 语句</p>
<p>mysql&gt; unlock tables;<br>Query OK, 0 rows affected (0.01 sec)</p>
</blockquote>
<h3 id="3-配置主从"><a href="#3-配置主从" class="headerlink" title="3.配置主从"></a>3.配置主从</h3><blockquote>
<p>从库配置主库内容</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">change master <span class="hljs-keyword">to</span><br>master_host<span class="hljs-operator">=</span><span class="hljs-string">&#x27;192.168.198.100&#x27;</span>,<br>master_user<span class="hljs-operator">=</span><span class="hljs-string">&#x27;repl&#x27;</span>,<br>master_password<span class="hljs-operator">=</span><span class="hljs-string">&#x27;123456&#x27;</span>,<br>master_log_file<span class="hljs-operator">=</span><span class="hljs-string">&#x27;tho_mysql.000001&#x27;</span>,<br>master_log_pos<span class="hljs-operator">=</span><span class="hljs-number">739</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>从库 执行  start slave 开启主从同步</p>
<p>从库查看主从信息  show slave status; </p>
</blockquote>
<h2 id="2-8、mycat常用分片规则"><a href="#2-8、mycat常用分片规则" class="headerlink" title="2.8、mycat常用分片规则"></a>2.8、mycat常用分片规则</h2><h3 id="1-枚举分片"><a href="#1-枚举分片" class="headerlink" title="1.枚举分片"></a>1.枚举分片</h3><blockquote>
<p>通过配置文件中配置可能的枚举id，自己配置分片，本规则适用于特定的场景，比如有些业务需要按照省市区来做保存，而全国的省市区是固定的，这类业务使用本条规则</p>
</blockquote>
<h3 id="2-取模分片"><a href="#2-取模分片" class="headerlink" title="2.取模分片"></a>2.取模分片</h3><blockquote>
<p>根据数据库某字段进行取模,按照取模的结果决定放到哪个数据库</p>
<p>后续扩展数据库,要按照当前数据库个数的n次方进行扩展</p>
</blockquote>
<h2 id="2-9、Mycat全局表"><a href="#2-9、Mycat全局表" class="headerlink" title="2.9、Mycat全局表"></a>2.9、Mycat全局表</h2><blockquote>
<p>数据表的数据量较小(例如字典表等等),可以在每个分片数据库中都存放一份,这样不需要多次的联表查询</p>
<p>==type属性：global为全局表==，不指定为分片表</p>
</blockquote>
<h2 id="2-10、Mycat子表"><a href="#2-10、Mycat子表" class="headerlink" title="2.10、Mycat子表"></a>2.10、Mycat子表</h2><blockquote>
<p>order(订单表) orderItem(订单明细表) 两表分库分表时最好放在同一个数据库中，减少跨库关联操作</p>
</blockquote>
<ul>
<li>childTable标签，定义分片子表</li>
<li>name属性，子表名称</li>
<li>joinKey属性，标志子表中的列，用于与父表做关联(orderId)</li>
<li>parentKey标签，标志父表中的列，与joinKey对应</li>
<li>primaryKey属性，子表主键，同table标签</li>
<li>needAddLimit属性，同table标签</li>
</ul>
<blockquote>
<p>schema.xml 配置</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 全局表配置 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;province&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn101,dn102&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;global&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 子表配置 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn101,dn102&quot;</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">&quot;auto-sharding-long&quot;</span> &gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">childTable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;order_item&quot;</span> <span class="hljs-attr">joinKey</span>=<span class="hljs-string">&quot;order_id&quot;</span> <span class="hljs-attr">parentKey</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h1 id="三、Mycat高可用"><a href="#三、Mycat高可用" class="headerlink" title="三、Mycat高可用"></a>三、Mycat高可用</h1><h2 id="3-1、Mycat-HA-原理"><a href="#3-1、Mycat-HA-原理" class="headerlink" title="3.1、Mycat-HA-原理"></a>3.1、Mycat-HA-原理</h2><blockquote>
<p>避免Mycat成为系统中的单点</p>
</blockquote>
<p>架构图</p>
<p><img src="%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20211229125856871.png" srcset="/img/loading.gif" lazyload alt="image-20211229125856871"></p>
<h2 id="3-2、Mycat-Haproxy"><a href="#3-2、Mycat-Haproxy" class="headerlink" title="3.2、Mycat-Haproxy"></a>3.2、Mycat-Haproxy</h2><p>192.168.198.100 (mysql服务，mycat服务，HAproxy)</p>
<p>192.168.198.101 (mysql服务，mycat服务)</p>
<p>192.168.198.102 (mysql服务，HaProxy服务)</p>
<blockquote>
<p>其中 100 和 101 两台主机是主从模式</p>
</blockquote>
<h3 id="1-安装HaProxy"><a href="#1-安装HaProxy" class="headerlink" title="1.安装HaProxy"></a>1.安装HaProxy</h3><blockquote>
<p>使用 yum 命令方式安装</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@centos_7_102 ~]# yum search haproxy<br>已加载插件：fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: mirrors.aliyun.com<br>=========================================================== N/S matched: haproxy ============================================================<br>pcp-pmda-haproxy.x86_64 : Performance Co-Pilot (PCP) metrics for HAProxy<br>haproxy.x86_64 : TCP/HTTP proxy and load balancer for high availability environments<br><br>  名称和简介匹配 only，使用“search all”试试。<br><span class="hljs-meta">#</span><span class="bash"> haproxy比nginx支持的协议更多，nginx只支持http协议</span><br><span class="hljs-meta">#</span><span class="bash"> 安装haproxy</span><br>[root@centos_7_102 ~]# yum -y install haproxy.x86_64<br></code></pre></td></tr></table></figure>

<blockquote>
<p>haproxy 配置文件所在目录 /etc/haproxy/haproxy.cfg</p>
</blockquote>
<ul>
<li> 修改配置文件,通过tcp连接mycat </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java">#---------------------------------------------------------------------<br># Example configuration <span class="hljs-keyword">for</span> a possible web application.  See the<br># full configuration options online.<br>#<br>#   http:<span class="hljs-comment">//haproxy.1wt.eu/download/1.4/doc/configuration.txt</span><br>#<br>#---------------------------------------------------------------------<br><br>#---------------------------------------------------------------------<br># Global settings<br>#---------------------------------------------------------------------<br>global<br>    # to have these messages end up in /<span class="hljs-keyword">var</span>/log/haproxy.log you will<br>    # need to:<br>    #<br>    # <span class="hljs-number">1</span>) configure syslog to accept network log events.  This is done<br>    #    by adding the <span class="hljs-string">&#x27;-r&#x27;</span> option to the SYSLOGD_OPTIONS in<br>    #    /etc/sysconfig/syslog<br>    #<br>    # <span class="hljs-number">2</span>) configure local2 events to go to the /<span class="hljs-keyword">var</span>/log/haproxy.log<br>    #   file. A line like the following can be added to<br>    #   /etc/sysconfig/syslog<br>    #<br>    #    local2.*                       /<span class="hljs-keyword">var</span>/log/haproxy.log<br>    #<br>    log         <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> local2<br><br>    chroot      /<span class="hljs-keyword">var</span>/lib/haproxy<br>    pidfile     /<span class="hljs-keyword">var</span>/run/haproxy.pid<br>    maxconn     <span class="hljs-number">4000</span><br>    user        haproxy<br>    group       haproxy<br>    daemon<br><br>    # turn on stats unix socket<br>    stats socket /<span class="hljs-keyword">var</span>/lib/haproxy/stats<br><br>#---------------------------------------------------------------------<br># common defaults that all the <span class="hljs-string">&#x27;listen&#x27;</span> and <span class="hljs-string">&#x27;backend&#x27;</span> sections will<br># use <span class="hljs-keyword">if</span> not designated in their block<br>#---------------------------------------------------------------------<br>defaults<br>    mode                    tcp<br>    log                     global<br>    option                  tcplog<br>    option                  dontlognull<br>    # option http-server-close<br>    # option forwardfor       except <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">8</span><br>    option                  redispatch<br>    retries                 <span class="hljs-number">3</span><br>    timeout http-request    10s<br>    timeout queue           1m<br>    timeout connect         10s<br>    timeout client          1m<br>    timeout server          1m<br>    timeout http-keep-alive 10s<br>    timeout check           10s<br>    maxconn                 <span class="hljs-number">3000</span><br><br>#---------------------------------------------------------------------<br># main frontend which proxys to the backends<br>#---------------------------------------------------------------------<br>frontend  main *:<span class="hljs-number">5000</span><br>    # acl url_static       path_beg       -i /<span class="hljs-keyword">static</span> /images /javascript /stylesheets<br>    # acl url_static       path_end       -i .jpg .gif .png .css .js<br><br>    # use_backend <span class="hljs-keyword">static</span>          <span class="hljs-keyword">if</span> url_static<br>    default_backend             app<br><br>#---------------------------------------------------------------------<br># <span class="hljs-keyword">static</span> backend <span class="hljs-keyword">for</span> serving up images, stylesheets and such<br>#---------------------------------------------------------------------<br>backend <span class="hljs-keyword">static</span><br>    balance     roundrobin<br>    server      <span class="hljs-keyword">static</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">4331</span> check<br><br>#---------------------------------------------------------------------<br># round robin balancing between the various backends<br>#---------------------------------------------------------------------<br>backend app<br>    balance     roundrobin<br>    server  app1 <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.100</span>:<span class="hljs-number">8066</span> check<br>    server  app2 <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.101</span>:<span class="hljs-number">8066</span> check<br>    # server  app3 <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">5003</span> check<br>    # server  app4 <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">5004</span> check<br><br><br></code></pre></td></tr></table></figure>

<h3 id="2-启动HAProxy"><a href="#2-启动HAProxy" class="headerlink" title="2.启动HAProxy"></a>2.启动HAProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@centos_7_102 ~]# haproxy -f /etc/haproxy/haproxy.cfg <br></code></pre></td></tr></table></figure>

<ul>
<li>使用 navicat 测试 haproxy  5000 端口 (需要输入该主机上mycat的密码)</li>
</ul>
<p>这样修改 haproxy 配置文件就可以消除警告信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs xml">#---------------------------------------------------------------------<br># Example configuration for a possible web application.  See the<br># full configuration options online.<br>#<br>#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt<br>#<br>#---------------------------------------------------------------------<br><br>#---------------------------------------------------------------------<br># Global settings<br>#---------------------------------------------------------------------<br>global<br>    # to have these messages end up in /var/log/haproxy.log you will<br>    # need to:<br>    #<br>    # 1) configure syslog to accept network log events.  This is done<br>    #    by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in<br>    #    /etc/sysconfig/syslog<br>    #<br>    # 2) configure local2 events to go to the /var/log/haproxy.log<br>    #   file. A line like the following can be added to<br>    #   /etc/sysconfig/syslog<br>    #<br>    #    local2.*                       /var/log/haproxy.log<br>    #<br>    log         127.0.0.1 local2<br><br>    chroot      /var/lib/haproxy<br>    pidfile     /var/run/haproxy.pid<br>    maxconn     4000<br>    user        haproxy<br>    group       haproxy<br>    daemon<br><br>    # turn on stats unix socket<br>    stats socket /var/lib/haproxy/stats<br><br>#---------------------------------------------------------------------<br># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will<br># use if not designated in their block<br>#---------------------------------------------------------------------<br>defaults<br>    mode                    tcp<br>    log                     global<br>    option                  tcplog<br>    option                  dontlognull<br>    # option http-server-close<br>    # option forwardfor       except 127.0.0.0/8<br>    option                  redispatch<br>    retries                 3<br>    timeout http-request    10s<br>    timeout queue           1m<br>    timeout connect         10s<br>    timeout client          1m<br>    timeout server          1m<br>    timeout http-keep-alive 10s<br>    timeout check           10s<br>    maxconn                 3000<br><br>#---------------------------------------------------------------------<br># main frontend which proxys to the backends<br>#---------------------------------------------------------------------<br>frontend  main *:5000<br>    # acl url_static       path_beg       -i /static /images /javascript /stylesheets<br>    # acl url_static       path_end       -i .jpg .gif .png .css .js<br><br>    # use_backend static          if url_static<br>    default_backend             app<br><br>#---------------------------------------------------------------------<br># static backend for serving up images, stylesheets and such<br>#---------------------------------------------------------------------<br>backend static<br>    balance     roundrobin<br>    server      static 127.0.0.1:4331 check<br><br>#---------------------------------------------------------------------<br># round robin balancing between the various backends<br>#---------------------------------------------------------------------<br>backend app<br>    balance     roundrobin<br>    server  app1 192.168.198.100:8066 check<br>    server  app2 192.168.198.101:8066 check<br>    # server  app3 127.0.0.1:5003 check<br>    # server  app4 127.0.0.1:5004 check<br><br><br></code></pre></td></tr></table></figure>

<h2 id="3-3、keepAlived环境配置"><a href="#3-3、keepAlived环境配置" class="headerlink" title="3.3、keepAlived环境配置"></a>3.3、keepAlived环境配置</h2><h3 id="1-安装keepAlived"><a href="#1-安装keepAlived" class="headerlink" title="1.安装keepAlived"></a>1.安装keepAlived</h3><blockquote>
<p>通过 yum 方式安装 keepAlived</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum search keepalived<br>[root@centos_7_100 mycat]# yum install -y keepalived.x86_64<br></code></pre></td></tr></table></figure>

<h3 id="2-keepAlived配置文件"><a href="#2-keepAlived配置文件" class="headerlink" title="2.keepAlived配置文件"></a>2.keepAlived配置文件</h3><blockquote>
<p>192.168.198.100   keepAlived 配置文件修改 (主节点)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     test<span class="hljs-meta">@qq</span>.com<br>   &#125;<br>   # notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc<br>   # smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   # smtp_connect_timeout <span class="hljs-number">30</span><br>   router_id node1<br>   # vrrp_skip_check_adv_addr<br>   # vrrp_strict<br>   # vrrp_garp_interval <span class="hljs-number">0</span><br>   # vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ens33</span></span><br><span class="hljs-class">    <span class="hljs-title">virtual_router_id</span> 51</span><br><span class="hljs-class">    <span class="hljs-title">priority</span> 100</span><br><span class="hljs-class">    <span class="hljs-title">advert_int</span> 1</span><br><span class="hljs-class">    <span class="hljs-title">authentication</span> </span>&#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>    virtual_ipaddress &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span><br>    &#125;<br>&#125;<br><br>virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span> <span class="hljs-number">6000</span> &#123;<br>    delay_loop <span class="hljs-number">6</span><br>    lb_algo rr<br>    lb_kind NAT<br>    persistence_timeout <span class="hljs-number">50</span><br>    protocol TCP<br><br>    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.100</span> <span class="hljs-number">5000</span> &#123;<br>        weight <span class="hljs-number">1</span><br>        TCP_CHECK &#123;<br>            connect_port <span class="hljs-number">5000</span><br>			connect_timeout <span class="hljs-number">10000</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>192.168.198.101  keepAlived 配置文件修改 (备节点)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     test<span class="hljs-meta">@qq</span>.com<br>   &#125;<br>   # notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc<br>   # smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   # smtp_connect_timeout <span class="hljs-number">30</span><br>   router_id node2<br>   # vrrp_skip_check_adv_addr<br>   # vrrp_strict<br>   # vrrp_garp_interval <span class="hljs-number">0</span><br>   # vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ens33</span></span><br><span class="hljs-class">    <span class="hljs-title">virtual_router_id</span> 51</span><br><span class="hljs-class">    <span class="hljs-title">priority</span> 99</span><br><span class="hljs-class">    <span class="hljs-title">advert_int</span> 1</span><br><span class="hljs-class">    <span class="hljs-title">authentication</span> </span>&#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>    virtual_ipaddress &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span><br>    &#125;<br>&#125;<br><br>virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span> <span class="hljs-number">6000</span> &#123;<br>    delay_loop <span class="hljs-number">6</span><br>    lb_algo rr<br>    lb_kind NAT<br>    persistence_timeout <span class="hljs-number">50</span><br>    protocol TCP<br><br>    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.101</span> <span class="hljs-number">5000</span> &#123;<br>        weight <span class="hljs-number">1</span><br>        TCP_CHECK &#123;<br>            connect_port <span class="hljs-number">5000</span><br>			connect_timeout <span class="hljs-number">10000</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-启动keepAlived"><a href="#3-启动keepAlived" class="headerlink" title="3.启动keepAlived"></a>3.启动keepAlived</h3><blockquote>
<p>[root@centos_7_100 mycat]# keepalived -f /etc/keepalived/keepalived.conf </p>
</blockquote>
<h3 id="4-小问题"><a href="#4-小问题" class="headerlink" title="4.小问题"></a>4.小问题</h3><blockquote>
<p>这样配置完 keepAlived 在其中一台keepAlived 宕机的情况下会自动切换,但是 keepAlived 连接的服务宕机,keepAlived不会进行切换,会一直报错</p>
</blockquote>
<ul>
<li><p>解决办法：写一个脚本，后续连接的服务宕机之后,关掉当前的keepAlived服务，让keepAlived服务被动切换</p>
</li>
<li><p>需要使用 killall命令 该命令不存在则用yum 进行安装即可</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@centos_7_100 mycat]# killall -0 haproxy<br>-bash: killall: 未找到命令<br>[root@centos_7_100 mycat]# yum search killall<br>已加载插件：fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: mirrors.aliyun.com<br>========================================================================= 匹配：killall =========================================================================<br>psmisc.x86_64 : Utilities for managing processes on your system<br>[root@centos_7_100 mycat]# yum install -y psmisc.x86_64<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@centos_7_100 mycat]# killall -0 haproxy<br>[root@centos_7_100 mycat]# echo $?<br>0<br><span class="hljs-meta">#</span><span class="bash"> killall 命令只是用来探测相关服务,不会终止掉相关服务</span><br></code></pre></td></tr></table></figure>

<h3 id="5-加入检测haproxy状态的脚本"><a href="#5-加入检测haproxy状态的脚本" class="headerlink" title="5.加入检测haproxy状态的脚本"></a>5.加入检测haproxy状态的脚本</h3><p>keepAlived配置文件 /etc/keepalived/keepalived.conf </p>
<p>192.168.198.100 keepAlived 配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     test<span class="hljs-meta">@qq</span>.com<br>   &#125;<br>   # notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc<br>   # smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   # smtp_connect_timeout <span class="hljs-number">30</span><br>   router_id node1<br>   # vrrp_skip_check_adv_addr<br>   # vrrp_strict<br>   # vrrp_garp_interval <span class="hljs-number">0</span><br>   # vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br><br>vrrp_script chk_haproxy &#123;<br>	script <span class="hljs-string">&quot;killall -0 haproxy&quot;</span><br>	interval  <span class="hljs-number">2</span><br>&#125;<br><br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ens33</span></span><br><span class="hljs-class">    <span class="hljs-title">virtual_router_id</span> 51</span><br><span class="hljs-class">    <span class="hljs-title">priority</span> 100</span><br><span class="hljs-class">    <span class="hljs-title">advert_int</span> 1</span><br><span class="hljs-class">    <span class="hljs-title">authentication</span> </span>&#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>    virtual_ipaddress &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span><br>    &#125;<br>	track_script &#123;<br>		chk_haproxy<br>	&#125;<br>&#125;<br><br>virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span> <span class="hljs-number">6000</span> &#123;<br>    delay_loop <span class="hljs-number">6</span><br>    lb_algo rr<br>    lb_kind NAT<br>    persistence_timeout <span class="hljs-number">50</span><br>    protocol TCP<br><br>    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.100</span> <span class="hljs-number">5000</span> &#123;<br>        weight <span class="hljs-number">1</span><br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>keepAlived配置文件 /etc/keepalived/keepalived.conf </p>
<p>192.168.198.101 keepAlived 配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     test<span class="hljs-meta">@qq</span>.com<br>   &#125;<br>   # notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc<br>   # smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   # smtp_connect_timeout <span class="hljs-number">30</span><br>   router_id node2<br>   # vrrp_skip_check_adv_addr<br>   # vrrp_strict<br>   # vrrp_garp_interval <span class="hljs-number">0</span><br>   # vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br>vrrp_script chk_haproxy &#123;<br>	script <span class="hljs-string">&quot;killall -0 haproxy&quot;</span><br>	interval  <span class="hljs-number">2</span><br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ens33</span></span><br><span class="hljs-class">    <span class="hljs-title">virtual_router_id</span> 51</span><br><span class="hljs-class">    <span class="hljs-title">priority</span> 99</span><br><span class="hljs-class">    <span class="hljs-title">advert_int</span> 1</span><br><span class="hljs-class">    <span class="hljs-title">authentication</span> </span>&#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>  	virtual_ipaddress &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span><br>    &#125;<br>    track_script &#123;<br>			chk_haproxy<br>		&#125;<br>&#125;<br><br>virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.99</span> <span class="hljs-number">6000</span> &#123;<br>    delay_loop <span class="hljs-number">6</span><br>    lb_algo rr<br>    lb_kind NAT<br>    persistence_timeout <span class="hljs-number">50</span><br>    protocol TCP<br><br>    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.198</span><span class="hljs-number">.101</span> <span class="hljs-number">5000</span> &#123;<br>        weight <span class="hljs-number">1</span><br>        <br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h1 id="四、Springboot整合Mycat"><a href="#四、Springboot整合Mycat" class="headerlink" title="四、Springboot整合Mycat"></a>四、Springboot整合Mycat</h1><h2 id="4-1、基本环境"><a href="#4-1、基本环境" class="headerlink" title="4.1、基本环境"></a>4.1、基本环境</h2><p>192.168.198.100    192.168.198.101 两台服务器是主从关系，100 是主节点 101 是从节点</p>
<blockquote>
<p>对数据库进行分库分表</p>
<p>只拆分订单相关的三张表 order order_items order_status</p>
</blockquote>
<h2 id="4-2、分片规则"><a href="#4-2、分片规则" class="headerlink" title="4.2、分片规则"></a>4.2、分片规则</h2><blockquote>
<p>分片字段要选择 userId 这样一个用户的订单会进入到一个节点，不会分布到多个节点</p>
<p>auto-sharding-long 只能用户整型变量</p>
</blockquote>
<p>一致性Hash</p>
<p><img src="%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20220101114327186.png" srcset="/img/loading.gif" lazyload alt="image-20220101114327186"></p>
<blockquote>
<p>在 rule.xml 配置分片选择的字段</p>
<tableRule name="sharding-by-murmur">
        <rule>
            <columns>user_id</columns>
            <algorithm>murmur</algorithm>
        </rule>
    </tableRule>

<p><function name="murmur"
        class="io.mycat.route.function.PartitionByMurmurHash"><br>        <property name="seed">0</property><!-- 默认是0 --><br>        <property name="count">2</property><!-- 要分片的数据库节点数量，必须指定，否则没法分片 --><br>        <property name="virtualBucketTimes">160</property><!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --><br>        <!-- <property name="weightMapFile">weightMapFile</property> 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --><br>        <!-- <property name="bucketMapPath">/etc/mycat/bucketMapPath</property> 
            用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --><br>    </function></p>
</blockquote>
<blockquote>
<p>mycat 中 作为选择数据库分片的字段不能进行更新</p>
<p>有子表配置时，先插入主表，才能进行子表的插入</p>
</blockquote>
<h1 id="五、Sharding-Jdbc使用"><a href="#五、Sharding-Jdbc使用" class="headerlink" title="五、Sharding-Jdbc使用"></a>五、Sharding-Jdbc使用</h1><h2 id="5-0、使用Mybatis-generator"><a href="#5-0、使用Mybatis-generator" class="headerlink" title="5.0、使用Mybatis-generator"></a>5.0、使用Mybatis-generator</h2><h3 id="1、pom-xml-中加入配置"><a href="#1、pom-xml-中加入配置" class="headerlink" title="1、pom.xml 中加入配置"></a>1、pom.xml 中加入配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>	<br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2、引入配置文件"><a href="#2、引入配置文件" class="headerlink" title="2、引入配置文件"></a>2、引入配置文件</h3><blockquote>
<p>generatorConfig.xml</p>
<p>修改配置</p>
<ul>
<li><p>connectionURL=”jdbc:mysql://192.168.198.101:3306/shard_order?serverTimezone=Asia/Shanghai&amp;useSSL=false”</p>
</li>
<li><javaModelGenerator targetPackage="com.tho.shardingjdbcdemo.model" targetProject="src\main\java"></li>
<li><sqlMapGenerator targetPackage="mybatis"  targetProject="src\main\resources"></li>
<li><javaClientGenerator type="XMLMAPPER" targetPackage="com.tho.shardingjdbcdemo.dao"  targetProject="src\main\java"></li>
<li><p>```xml</p>
  <table schema="shard_order" tableName="t_order_1" domainObjectName="Order" ></table>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br>```xml<br><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">generatorConfiguration</span></span><br><span class="hljs-meta">       <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="hljs-meta">       <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">generatorConfiguration</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">context</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;MysqlTables&quot;</span> <span class="hljs-attr">targetRuntime</span>=<span class="hljs-string">&quot;MyBatis3&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span> <span class="hljs-attr">driverClass</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="hljs-tag">                       <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">&quot;jdbc:mysql://192.168.198.101:3306/shard_order?serverTimezone=Asia/Shanghai<span class="hljs-symbol">&amp;amp;</span>useSSL=false&quot;</span></span><br><span class="hljs-tag">                       <span class="hljs-attr">userId</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">                       <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;nullCatalogMeansCurrent&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">javaTypeResolver</span> &gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;forceBigDecimals&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">javaTypeResolver</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">javaModelGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.tho.shardingjdbcdemo.model&quot;</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src\main\java&quot;</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;trimStrings&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">javaModelGenerator</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">sqlMapGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;mybatis&quot;</span>  <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src\main\resources&quot;</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">sqlMapGenerator</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">javaClientGenerator</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;XMLMAPPER&quot;</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.tho.shardingjdbcdemo.dao&quot;</span>  <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src\main\java&quot;</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">javaClientGenerator</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">schema</span>=<span class="hljs-string">&quot;shard_order&quot;</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;t_order_1&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;Order&quot;</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><br><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">generatorConfiguration</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<h2 id="5-1、sharding-jdbc简介"><a href="#5-1、sharding-jdbc简介" class="headerlink" title="5.1、sharding-jdbc简介"></a>5.1、sharding-jdbc简介</h2><ul>
<li>Sharing-Jdbc 是一个客户端代理模式,不需要单独启动服务，直接使用 jar 包即可</li>
<li>开源 分布式关系型数据库中间件</li>
<li>目前已经进入Apache 孵化器</li>
<li>定位为轻量级java框架，以jar包提供服务</li>
<li>可以理解为增强版 jdbc 驱动</li>
<li>完全兼容各种 ORM 框架</li>
</ul>
<p><img src="%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.assets/image-20220101152521852.png" srcset="/img/loading.gif" lazyload alt="image-20220101152521852"></p>
<blockquote>
<p>提供了四种配置方式</p>
<ul>
<li>Java API ，Yaml，SpringBoot 和 Spring 命名空间</li>
</ul>
</blockquote>
<blockquote>
<p>与 Mycat 的区别</p>
<ul>
<li>Mycat 是服务端代理 Sharding-Jdbc 是客户端代理</li>
<li>Mycat 不支持同一库内水平切分，Sharding-Jdbc 支持</li>
</ul>
</blockquote>
<h2 id="5-2、Sharing-Jdbc分片表"><a href="#5-2、Sharing-Jdbc分片表" class="headerlink" title="5.2、Sharing-Jdbc分片表"></a>5.2、Sharing-Jdbc分片表</h2><blockquote>
<p>环境配置 两个数据库 </p>
<p>数据库1 (两个表) </p>
<ul>
<li>t_order_1 </li>
<li>t_order_2</li>
</ul>
<p>数据库2 (两个表)</p>
<ul>
<li>t_order_1</li>
<li>t_order_2</li>
</ul>
<p>根据 userId 区分不同数据库 (奇偶区分)</p>
<p>根据 id 区分不同表 (奇偶区分)</p>
</blockquote>
<h2 id="5-3、SpringBoot整合ShardingJdbc"><a href="#5-3、SpringBoot整合ShardingJdbc" class="headerlink" title="5.3、SpringBoot整合ShardingJdbc"></a>5.3、SpringBoot整合ShardingJdbc</h2><h3 id="1、maven依赖"><a href="#1、maven依赖" class="headerlink" title="1、maven依赖"></a>1、maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.shardingsphere/sharding-jdbc-spring-boot-starter --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0-RC2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2、配置文件配置"><a href="#2、配置文件配置" class="headerlink" title="2、配置文件配置"></a>2、配置文件配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 配置真实数据源</span><br><span class="hljs-meta">spring.shardingsphere.datasource.names</span>=<span class="hljs-string">ds1,ds2</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 配置第 1 个数据源</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.jdbcUrl</span>=<span class="hljs-string">jdbc:mysql://192.168.198.101:3306/shard_order</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 配置第 2 个数据源</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds2.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds2.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds2.jdbcUrl</span>=<span class="hljs-string">jdbc:mysql://192.168.198.102:3306/sharding-order</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds2.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds2.password</span>=<span class="hljs-string">123456</span><br><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.actual-data-nodes</span>=<span class="hljs-string">ds$-&gt;&#123;1..2&#125;.t_order_$-&gt;&#123;1..2&#125;</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.database-strategy.inline.sharding-column</span>=<span class="hljs-string">user_id</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.database-strategy.inline.algorithm-expression</span>=<span class="hljs-string">ds$-&gt;&#123;user_id % 2 + 1&#125; # 根据奇偶选择分片时注意数据库和表的名称</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column</span>=<span class="hljs-string">id</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression</span>=<span class="hljs-string">t_order_$-&gt;&#123;id % 2 + 1&#125;</span><br><br><span class="hljs-meta">mybatis.mapper-locations</span>=<span class="hljs-string">/mybatis/*.xml</span><br><br><br></code></pre></td></tr></table></figure>



<h3 id="3、mapper-文件要修改，要改成逻辑表的名称"><a href="#3、mapper-文件要修改，要改成逻辑表的名称" class="headerlink" title="3、mapper 文件要修改，要改成逻辑表的名称"></a>3、mapper 文件要修改，要改成逻辑表的名称</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;select id=<span class="hljs-string">&quot;countByExample&quot;</span> parameterType=<span class="hljs-string">&quot;com.tho.shardingjdbcdemo.model.OrderExample&quot;</span> resultType=<span class="hljs-string">&quot;java.lang.Long&quot;</span>&gt;<br> <br>  <span class="hljs-comment">// 本来是 select count(*) from t_order_1 (由mybatis-generator 生成的mapper) </span><br>  <span class="hljs-function">select <span class="hljs-title">count</span><span class="hljs-params">(*)</span> from t_order</span><br><span class="hljs-function">  &lt;<span class="hljs-keyword">if</span> test</span>=<span class="hljs-string">&quot;_parameter != null&quot;</span>&gt;<br>    &lt;include refid=<span class="hljs-string">&quot;Example_Where_Clause&quot;</span> /&gt;<br>  &lt;/<span class="hljs-keyword">if</span>&gt;<br>&lt;/select&gt;<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tho.shardingjdbcdemo;<br><br><span class="hljs-keyword">import</span> com.tho.shardingjdbcdemo.dao.OrderMapper;<br><span class="hljs-keyword">import</span> com.tho.shardingjdbcdemo.model.Order;<br><span class="hljs-keyword">import</span> com.tho.shardingjdbcdemo.model.OrderExample;<br><span class="hljs-keyword">import</span> javafx.application.Application;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = ShardingJdbcDemoApplication.class)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShardingJdbcDemoApplicationTests</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">contextLoads</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shardingJdbcInsertTest</span><span class="hljs-params">()</span> </span>&#123;<br>        Order order = <span class="hljs-keyword">new</span> Order();<br>        order.setId(<span class="hljs-number">2</span>);<br>        order.setUserId(<span class="hljs-number">1</span>);<br>        order.setOrderAmount(<span class="hljs-number">2L</span>);<br>        order.setOrderStatus(<span class="hljs-number">2</span>);<br><br>        orderMapper.insert(order);<br>    &#125;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shardingJdbcQueryTest</span><span class="hljs-params">()</span> </span>&#123;<br>        OrderExample orderExample = <span class="hljs-keyword">new</span> OrderExample();<br>        OrderExample.Criteria criteria = orderExample.createCriteria().andIdEqualTo(<span class="hljs-number">2</span>).andUserIdEqualTo(<span class="hljs-number">1</span>);<br><br>        List&lt;Order&gt; orders = orderMapper.selectByExample(orderExample);<br>        orders.forEach(o -&gt; System.out.println(o.getId() +  <span class="hljs-string">&quot;---&quot;</span>+ o.getUserId()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5、mybatis-generator生成的通用mapper"><a href="#5、mybatis-generator生成的通用mapper" class="headerlink" title="5、mybatis-generator生成的通用mapper"></a>5、mybatis-generator生成的通用mapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 参数是 对应类的 Example 类 不是 Criteria 类</span><br><span class="hljs-function">List&lt;Order&gt; <span class="hljs-title">selectByExample</span><span class="hljs-params">(OrderExample example)</span></span>; <br></code></pre></td></tr></table></figure>

<h2 id="5-4、ShardingJdbc全局表"><a href="#5-4、ShardingJdbc全局表" class="headerlink" title="5.4、ShardingJdbc全局表"></a>5.4、ShardingJdbc全局表</h2><blockquote>
<p>环境准备</p>
<ul>
<li>各个数据库分片建立 全局表 </li>
<li>配置文件修改 加入下面一行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.shardingsphere.sharding.broadcast-tables=area<br></code></pre></td></tr></table></figure>


</blockquote>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shardingJdbcGlobalTest</span><span class="hljs-params">()</span> </span>&#123;<br>    Area area = <span class="hljs-keyword">new</span> Area();<br>    area.setId(<span class="hljs-number">1</span>);<br>    area.setName(<span class="hljs-string">&quot;北京&quot;</span>);<br>    areaMapper.insert(area);<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>启动测试方法，两张表都加入了 插入的数据</p>
</blockquote>
<h2 id="5-5、ShardingJdbc子表"><a href="#5-5、ShardingJdbc子表" class="headerlink" title="5.5、ShardingJdbc子表"></a>5.5、ShardingJdbc子表</h2><h2 id="5-6、ShardingJdbc-读写分离"><a href="#5-6、ShardingJdbc-读写分离" class="headerlink" title="5.6、ShardingJdbc 读写分离"></a>5.6、ShardingJdbc 读写分离</h2>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章可随意转载
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/12/29/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">分布式事务</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/12/26/Zookeeper/">
                        <span class="hidden-mobile">分布式锁</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
